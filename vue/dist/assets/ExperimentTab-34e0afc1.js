import{u as ke,_ as se,r as z,o as T,c as P,a as D,n as ae,t as X,w as ue,v as ce,b as Q,d as G,e as ge,f as O,g as oe,h as ee,F as de,i as me,j as ie,l as c,k as I,m as pe,p as Ve,q as W,s as A,x as De,y as Se,z as Me,A as Te,B as $e,C as ve}from"./index-90c196b6.js";/* empty css              */import{u as Ee}from"./device-605269f5.js";import{T as Ne,V as Le}from"./VialPlot-90ada296.js";import"./plotly-afc049ba.js";const be="/assets/bottle_mask-3f9b6cbf.png",Pe="/assets/bottle-e2f639bd.png";const he={name:"BottleSingle",props:{totalVolume:{type:Number,required:!0},currentVolume:{type:Number,required:!0},bottleName:{type:String,required:!0,validator:t=>["main","drug","waste"].includes(t)},icon:{type:String,default:""},liquidColor:{type:String,default:"rgba(255, 215, 0, 0.6)"},concentration:{type:Number,default:null},units:{type:String,default:"units"}},data(){return{maskImage:new Image,maskLoaded:!1,maskData:null,editing:{total:!1,current:!1,concentration:!1,units:!1},editingValue:0,bottleNaturalWidth:0,bottleNaturalHeight:0,canvasWidth:150,canvasHeight:0,updateTimeout:null,isUpdating:!1}},computed:{safeCurrentVolume(){return typeof this.currentVolume=="number"&&!isNaN(this.currentVolume)?this.currentVolume.toFixed(1):"---"},showConcentration(){return this.bottleName==="drug"&&this.concentration!==null&&this.bottleName!=="waste"},bottleScale(){const t=Math.min(Math.max(this.totalVolume,100),5e3);return Math.max(Math.pow(t/1e3,1/3),.5)},bottleNameStyle(){return{transform:`translateX(-50%) scale(${1/this.bottleScale})`,fontSize:`${1.2*this.bottleScale}rem`}},fillPercentage(){const t=this.totalVolume*1.21;return Math.min(this.currentVolume/t*100,100)},bottleImgStyle(){const t=this.$refs.bottleImg,e=(t==null?void 0:t.naturalWidth)||100,v=(t==null?void 0:t.naturalHeight)||200,{drawW:m,drawH:y,offsetX:d,offsetY:M}=this.getImageDrawParams(e,v);return{width:m+"px",height:y+"px",left:d+"px",top:M+"px",position:"absolute",background:"transparent",zIndex:1,transition:"filter 0.3s",display:"block",objectFit:"fill"}},bottleContainerStyle(){const t=this.bottleNaturalWidth/this.bottleNaturalHeight,e=150,v=e/t;return{width:e+"px",height:v+"px"}}},methods:{getImageDrawParams(t,e){const v=this.canvasWidth,m=this.canvasHeight,y=Math.min(v/t,m/e),d=t*y,M=e*y,a=(v-d)/2,b=(m-M)/2;return{drawW:d,drawH:M,offsetX:a,offsetY:b,scale:y}},updateLiquid(){if(!this.maskLoaded||!this.maskData)return;const t=this.$refs.liquidCanvas;if(!t){console.warn("Liquid canvas ref not available yet");return}const e=t.getContext("2d");if(!e){console.error("Could not get liquid canvas context");return}this.getImageDrawParams(this.maskImage.width,this.maskImage.height),e.clearRect(0,0,t.width,t.height);let v=t.height,m=0;for(let a=0;a<t.height;a++)for(let b=0;b<t.width;b++){const _=(a*t.width+b)*4;this.maskData[_]<20&&this.maskData[_+1]<20&&this.maskData[_+2]<20&&this.maskData[_+3]===255&&(v=Math.min(v,a),m=Math.max(m,a))}const y=m-v,d=this.fillPercentage/100*y,M=m-d;for(let a=0;a<t.height;a++)for(let b=0;b<t.width;b++){const _=(a*t.width+b)*4,x=this.maskData[_]<20&&this.maskData[_+1]<20&&this.maskData[_+2]<20&&this.maskData[_+3]===255;a>=M&&x&&(e.fillStyle=this.liquidColor,e.fillRect(b,a,1,1))}},startEditing(t){console.log(`[BottleSingle] Starting edit for field: ${t}`),console.log(`[BottleSingle] Current props - totalVolume: ${this.totalVolume}, currentVolume: ${this.currentVolume}`),this.editing[t]=!0,t==="total"||t==="current"||t==="concentration"?this.editingValue=Number(Number(t==="total"?this.totalVolume:t==="current"?this.currentVolume:this.concentration).toFixed(4)):this.editingValue=t==="units"?this.units:0,console.log(`[BottleSingle] Set editingValue to: ${this.editingValue}`),this.$nextTick(()=>{this.$refs.volumeInput.focus()})},handleInput(t){console.log(`[BottleSingle] Handle input for field: ${t}, value: ${this.editingValue}`),this.updateTimeout&&clearTimeout(this.updateTimeout),t!=="units"&&(this.editingValue=Number(this.editingValue)),console.log(`[BottleSingle] Processed editingValue: ${this.editingValue}`)},finishEditing(t){if(console.log(`[BottleSingle] Finishing edit for field: ${t}`),console.log(`[BottleSingle] Final editingValue: ${this.editingValue}, isUpdating: ${this.isUpdating}`),!this.isUpdating){if(this.isUpdating=!0,t==="units"||this.editingValue>=0){const e=t==="total"?this.totalVolume:t==="current"?this.currentVolume:t==="concentration"?this.concentration:this.units,v="update:"+(t==="total"?"totalVolume":t==="current"?"currentVolume":t==="concentration"?"concentration":"units");console.log(`[BottleSingle] Emitting ${v} with value: ${this.editingValue} (old value: ${e})`),this.$emit(v,this.editingValue)}else console.log(`[BottleSingle] Skipping emit - invalid value: ${this.editingValue}`);this.editing[t]=!1,setTimeout(()=>{this.isUpdating=!1},100)}},cancelEditing(){console.log("[BottleSingle] Canceling edit"),this.updateTimeout&&clearTimeout(this.updateTimeout),this.editing.total=!1,this.editing.current=!1,this.editing.concentration=!1,this.editing.units=!1},initializeMask(){this.maskImage.src!==be&&(this.maskImage.src=be),this.maskImage.onload=()=>{this.canvasWidth>0&&this.canvasHeight>0?this.setupMaskCanvas():setTimeout(()=>this.setupMaskCanvas(),100)},this.maskImage.complete&&(this.canvasWidth>0&&this.canvasHeight>0?this.setupMaskCanvas():setTimeout(()=>this.setupMaskCanvas(),100))},setupMaskCanvas(){const t=this.$refs.maskCanvas;if(!t){console.warn("Mask canvas ref not available yet, retrying..."),setTimeout(()=>this.setupMaskCanvas(),50);return}const e=t.getContext("2d");if(!e){console.error("Could not get canvas context");return}if(this.canvasWidth<=0||this.canvasHeight<=0){console.warn("Canvas dimensions not ready yet, retrying mask setup..."),setTimeout(()=>this.setupMaskCanvas(),100);return}const v=this.maskImage.width,m=this.maskImage.height,{drawW:y,drawH:d,offsetX:M,offsetY:a,scale:b}=this.getImageDrawParams(v,m);e.clearRect(0,0,this.canvasWidth,this.canvasHeight),e.drawImage(this.maskImage,M,a,y,d),this.maskData=e.getImageData(0,0,this.canvasWidth,this.canvasHeight).data,this.maskLoaded=!0,this.updateLiquid()},setupBottleImage(){const t=this.$refs.bottleImg;if(t&&(t.onload=()=>{this.bottleNaturalWidth=t.naturalWidth,this.bottleNaturalHeight=t.naturalHeight;const e=this.bottleNaturalHeight/this.bottleNaturalWidth;this.canvasWidth=150,this.canvasHeight=Math.round(this.canvasWidth*e),this.maskImage.complete&&!this.maskLoaded&&this.setupMaskCanvas()},t.complete)){this.bottleNaturalWidth=t.naturalWidth,this.bottleNaturalHeight=t.naturalHeight;const e=this.bottleNaturalHeight/this.bottleNaturalWidth;this.canvasWidth=150,this.canvasHeight=Math.round(this.canvasWidth*e),this.maskImage.complete&&!this.maskLoaded&&this.setupMaskCanvas()}}},watch:{fillPercentage(){this.updateLiquid()}},mounted(){this.canvasWidth<=0&&(this.canvasWidth=150),this.canvasHeight<=0&&(this.canvasHeight=300),this.setupBottleImage(),this.initializeMask()},beforeUnmount(){window.removeEventListener("resize",this.updateCanvasSize)}},xe=()=>{ke(t=>({"48eb2166":t.canvasWidth+"px","1f016807":t.canvasHeight+"px",dc44b5c6:t.bottleScale}))},_e=he.setup;he.setup=_e?(t,e)=>(xe(),_e(t,e)):xe;const Ie={class:"bottle-container"},Fe={class:"bottle"},Oe={class:"bottle-content"},Be=["width","height"],We=["width","height"],He={class:"volume-display"},Ue=["title"],ze={key:4,class:"concentration-container"},Ae={class:"bottle-name"};function Re(t,e,v,m,y,d){const M=z("v-icon");return T(),P("div",Ie,[D("div",Fe,[D("div",Oe,[D("img",{src:Pe,alt:"Bottle",class:"bottle-image",style:ae(d.bottleImgStyle),ref:"bottleImg"},null,4),D("canvas",{ref:"maskCanvas",class:"mask-canvas",width:y.canvasWidth,height:y.canvasHeight},null,8,Be),D("canvas",{ref:"liquidCanvas",class:"liquid-canvas",width:y.canvasWidth,height:y.canvasHeight},null,8,We)]),D("div",He,[y.editing.total?ue((T(),P("input",{key:1,type:"number","onUpdate:modelValue":e[1]||(e[1]=a=>y.editingValue=a),onBlur:e[2]||(e[2]=a=>d.finishEditing("total")),onKeyup:[e[3]||(e[3]=Q(a=>d.finishEditing("total"),["enter"])),e[4]||(e[4]=Q((...a)=>d.cancelEditing&&d.cancelEditing(...a),["esc"]))],ref:"volumeInput",class:"volume-input","data-type":"total",title:"Max Volume"},null,544)),[[ce,y.editingValue,void 0,{number:!0}]]):(T(),P("div",{key:0,class:"total-volume",onDblclick:e[0]||(e[0]=a=>d.startEditing("total")),title:"Max Volume"},X(v.totalVolume)+"ml ",33)),y.editing.current?ue((T(),P("input",{key:3,type:"number","onUpdate:modelValue":e[6]||(e[6]=a=>y.editingValue=a),onBlur:e[7]||(e[7]=a=>d.finishEditing("current")),onKeyup:[e[8]||(e[8]=Q(a=>d.finishEditing("current"),["enter"])),e[9]||(e[9]=Q((...a)=>d.cancelEditing&&d.cancelEditing(...a),["esc"]))],ref:"volumeInput",class:"volume-input","data-type":"current",title:"Current Volume"},null,544)),[[ce,y.editingValue,void 0,{number:!0}]]):(T(),P("div",{key:2,class:"current-volume",onDblclick:e[5]||(e[5]=a=>d.startEditing("current")),title:`Current Volume: ${d.safeCurrentVolume}ml`},X(d.safeCurrentVolume)+"ml ",41,Ue)),d.showConcentration?(T(),P("div",ze,[y.editing.concentration?ue((T(),P("input",{key:1,type:"number","onUpdate:modelValue":e[11]||(e[11]=a=>y.editingValue=a),onBlur:e[12]||(e[12]=a=>d.finishEditing("concentration")),onKeyup:[e[13]||(e[13]=Q(a=>d.finishEditing("concentration"),["enter"])),e[14]||(e[14]=Q((...a)=>d.cancelEditing&&d.cancelEditing(...a),["esc"]))],ref:"volumeInput",class:"volume-input","data-type":"concentration",title:"Drug Concentration"},null,544)),[[ce,y.editingValue,void 0,{number:!0}]]):(T(),P("div",{key:0,class:"concentration",onDblclick:e[10]||(e[10]=a=>d.startEditing("concentration")),title:"Drug Concentration"},X(v.concentration!==null&&v.concentration!==void 0?Number(v.concentration).toFixed(2):""),33)),y.editing.units?ue((T(),P("input",{key:3,type:"text","onUpdate:modelValue":e[16]||(e[16]=a=>y.editingValue=a),onInput:e[17]||(e[17]=a=>d.handleInput("units")),onBlur:e[18]||(e[18]=a=>d.finishEditing("units")),onKeyup:[e[19]||(e[19]=Q(a=>d.finishEditing("units"),["enter"])),e[20]||(e[20]=Q((...a)=>d.cancelEditing&&d.cancelEditing(...a),["esc"]))],ref:"volumeInput",class:"volume-input","data-type":"units",title:"Concentration Units (for reference only)"},null,544)),[[ce,y.editingValue]]):(T(),P("div",{key:2,class:"units",onDblclick:e[15]||(e[15]=a=>d.startEditing("units")),title:"Concentration Units (for reference only)"},X(v.units),33))])):G("",!0)]),D("div",Ae,X(v.bottleName),1),v.icon?(T(),P("div",{key:0,class:ge(["bottle-icon",{"waste-icon":v.bottleName==="waste"}])},[O(M,{icon:v.icon,size:v.bottleName==="waste"?36:48},null,8,["icon","size"])],2)):G("",!0)])])}const je=se(he,[["render",Re],["__scopeId","data-v-17eff594"]]);const ye={name:"BottleDisplay",components:{BottleSingle:je},setup(){const t=oe(),e=ee(()=>t.currentExperiment||{}),v=[{name:"main"},{name:"drug"},{name:"waste"}];function m(E){const $=M(E),N=Math.min(Math.max($,100),5e3);return Math.max(Math.pow(N/1e3,1/3),.5)}function y(){return Math.max(...v.map(E=>m(E.name)))}function d(E){switch(E){case"main":return"rgba(255, 215, 0, 0.7)";case"drug":return"rgba(255, 165, 0, 0.7)";case"waste":return"rgba(255, 245, 0, 0.9)";default:return"rgba(255, 215, 0, 0.6)"}}function M(E){const $=e.value.parameters||{};switch(E){case"main":return Number($.bottle_volume_main)||0;case"drug":return Number($.bottle_volume_drug)||0;case"waste":return Number($.bottle_volume_waste)||0;default:return 0}}function a(E){const $=e.value.parameters||{};switch(E){case"main":return Number($.stock_volume_main)||0;case"drug":return Number($.stock_volume_drug)||0;case"waste":return Number($.stock_volume_waste)||0;default:return 0}}function b(){const E=e.value.parameters||{};return Number(E.stock_concentration_drug)||0}function _(){return(e.value.parameters||{}).concentration_units||"units"}async function x(E,$){console.log(`[BottleDisplay] updateBottleVolume called - bottleName: ${E}, value: ${$}`),console.log("[BottleDisplay] Current experiment parameters:",e.value.parameters);const N={...e.value.parameters};switch(E){case"main":N.bottle_volume_main=$;break;case"drug":N.bottle_volume_drug=$;break;case"waste":N.bottle_volume_waste=$;break}console.log("[BottleDisplay] Updated params:",N),await t.updateCurrentExperimentParameters(N),await t.fetchCurrentExperiment(),console.log("[BottleDisplay] Parameters updated and refreshed successfully")}async function B(E,$){console.log(`[BottleDisplay] updateCurrentVolume called - bottleName: ${E}, value: ${$}`),console.log("[BottleDisplay] Current experiment parameters:",e.value.parameters);const N={...e.value.parameters};switch(E){case"main":N.stock_volume_main=$;break;case"drug":N.stock_volume_drug=$;break;case"waste":N.stock_volume_waste=$;break}console.log("[BottleDisplay] Updated params:",N),await t.updateCurrentExperimentParameters(N),await t.fetchCurrentExperiment(),console.log("[BottleDisplay] Parameters updated and refreshed successfully")}async function k(E){console.log("updateConcentration called with value:",E);const $={...e.value.parameters},N=$.stock_concentration_drug;if(console.log("Current concentration:",N,"New concentration:",E),N!==E){$.stock_concentration_drug=E;for(let K=1;K<=7;K++)$.cultures[K]&&($.cultures[K].pump2_stock_drug_concentration=E);await t.updateCurrentExperimentParameters($),console.log("Parameters updated, showing toast"),c.success(`Drug concentration updated from ${N} to ${E} ${$.concentration_units}`)}}async function R(E){const $={...e.value.parameters};$.concentration_units=E,await t.updateCurrentExperimentParameters($)}return{bottles:v,getBottleVolume:M,getCurrentVolume:a,updateBottleVolume:x,updateCurrentVolume:B,getLiquidColor:d,getConcentration:b,updateConcentration:k,getUnits:_,updateUnits:R,getMaxScale:y,currentExperiment:e}}},we=()=>{ke(t=>({"006a042d":280*t.getMaxScale()+"px"}))},Ce=ye.setup;ye.setup=Ce?(t,e)=>(we(),Ce(t,e)):we;const qe={class:"bottle-display"};function Ke(t,e,v,m,y,d){const M=z("BottleSingle");return T(),P("div",qe,[m.currentExperiment?(T(!0),P(de,{key:0},me(m.bottles,a=>(T(),ie(M,{key:a.name,"bottle-name":a.name,"total-volume":m.getBottleVolume(a.name),"current-volume":m.getCurrentVolume(a.name),icon:a.name==="drug"?"mdi-biohazard":a.name==="waste"?"mdi-trash-can":"","liquid-color":m.getLiquidColor(a.name),concentration:a.name==="drug"?m.getConcentration():null,units:a.name==="drug"?m.getUnits():null,"onUpdate:totalVolume":b=>m.updateBottleVolume(a.name,b),"onUpdate:currentVolume":b=>m.updateCurrentVolume(a.name,b),"onUpdate:concentration":e[0]||(e[0]=b=>m.updateConcentration(b)),"onUpdate:units":e[1]||(e[1]=b=>m.updateUnits(b))},null,8,["bottle-name","total-volume","current-volume","icon","liquid-color","concentration","units","onUpdate:totalVolume","onUpdate:currentVolume"]))),128)):G("",!0)])}const Xe=se(ye,[["render",Ke],["__scopeId","data-v-f0a20bf4"]]);const Ye=["innerHTML"],Ge=["innerHTML"],Ze={__name:"ExperimentChecks",setup(t,{expose:e}){const v=oe(),m=Ee(),y=I(!1),d=I(null),M=I(!0),a=I(!0),b=I(null),_=I([{id:"experiment_timing",name:"Experiment Selection & Timing",status:"pending",loading:!1,tooltip:"Checks that an experiment is selected and verifies timing safety. Warns if resuming after >3h delay as culture dynamics can become unstable.",details:""},{id:"pump_calibration",name:"Pump Calibration Monotonicity",status:"pending",loading:!1,tooltip:"Validates that pump calibration values (ml/rotation) are monotonically descending. Higher speeds should pump less volume per rotation (e.g., 50 rots < 10 rots < 5 rots < 1 rot). <br><br/><b>Tip:</b> If calibration fails, check for air bubbles in the tubing during calibration.",details:""},{id:"stirrer_calibration",name:"Stirrer Calibration (High > Low)",status:"pending",loading:!1,tooltip:"Validates that stirrer high speed setting is greater than low speed setting for all vials (1-7). This ensures proper speed differentiation.",details:""},{id:"od",name:"OD Calibration (20mV < OD0 < 150mV)",status:"pending",loading:!1,tooltip:"Checks that optical density blank calibration is between 20-150mV for all vials to ensure accurate OD measurements",details:""},{id:"current_od",name:"Current OD Values",status:"pending",loading:!1,tooltip:"Measures the current OD of all vials to ensure they are properly zeroed before starting a new experiment.",details:""},{id:"stock",name:"Stock Concentrations Match (Vials 1-7 & Stock Bottle)",status:"pending",loading:!1,tooltip:"Verifies that all vials (1-7) have the same drug concentration as the stock bottle to ensure experiment consistency"},{id:"pump1",name:"Pump1 Concentration Zero (All Vials)",status:"pending",loading:!1,tooltip:"Ensures pump1 (main media) has zero drug concentration in all vials."},{id:"waste",name:"Waste Bottle Capacity vs Current Stock Volumes",status:"pending",loading:!1,tooltip:"Media use may exceed prediction and overfill the waste bottle. Checks that the waste bottle has enough space to fit all the medium and drug medium."},{id:"volume",name:"Stock Volume Sufficient (24h Simulation)",status:"pending",loading:!1,tooltip:"Runs a 24-hour simulation to predict media and drug consumption, ensuring sufficient stock volumes are available"}]);function x(n){return n==="passed"?"success":n==="failed"?"error":n==="warning"?"warning":"grey"}function B(n){return n==="passed"?"Passed":n==="failed"?"Failed":n==="warning"?"Warning":"Pending"}async function k(n){n.details="",await new Promise(C=>setTimeout(C,300));const i=v.currentExperiment;if(!i||!i.id){n.status="failed",n.details=`<span class="experiment-timing-value red">
      <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
      No experiment selected - please select or create an experiment
    </span>`,c("No experiment selected",{type:"error",autoClose:1e4});return}try{const C=await v.fetchExperimentSummary();let p=null;for(let f=1;f<=7;f++){const r=C[`vial${f}`];if(r&&r.od_timestamp){const s=new Date(r.od_timestamp).getTime();(!p||s>p)&&(p=s)}}if(!p){n.status="passed",n.details=`<span class="experiment-timing-value green">
        <i class="v-icon mdi mdi-check-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Experiment "${i.name}" selected - no previous OD data (new experiment)
      </span>`,c("Experiment ready - no previous data found",{type:"success",autoClose:1e4});return}const g=new Date(p),u=(new Date-g)/(1e3*60*60);if(u>24){n.status="failed";const f=Math.floor(u),r=Math.floor((u-f)*60);n.details=`<span class="experiment-timing-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Last OD measurement was ${f}h ${r}m ago. Experiments idle >24h must be restarted. Autoclave tubing and start a new experiment.
      </span>`,c(`Error: Last measurement was ${f}h ${r}m ago. Must start new experiment.`,{type:"error",autoClose:1e4})}else if(u>3){n.status="warning";const f=Math.floor(u),r=Math.floor((u-f)*60);n.details=`<span class="experiment-timing-value yellow">
        <i class="v-icon mdi mdi-alert-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Last OD measurement was ${f}h ${r}m ago. Resuming after >3h delays can cause unstable culture dynamics. Consider autoclaving tubing and starting a new experiment.
      </span>`,c(`Warning: Last measurement was ${f}h ${r}m ago. Consider starting fresh.`,{type:"warning",autoClose:1e4})}else{n.status="passed";const f=Math.floor(u),r=Math.floor((u-f)*60);n.details=`<span class="experiment-timing-value green">
        <i class="v-icon mdi mdi-check-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Experiment "${i.name}" selected - last measurement ${f}h ${r}m ago (safe to resume)
      </span>`,c("Experiment timing is safe for resumption",{type:"success",autoClose:1e4})}}catch{n.status="passed",n.details=`<span class="experiment-timing-value green">
      <i class="v-icon mdi mdi-check-circle" style="font-size: 16px; vertical-align: middle;"></i> 
      Experiment "${i.name}" selected - no previous data available (new experiment)
    </span>`,c("Experiment selected - no previous data available",{type:"success",autoClose:1e4})}}const R=()=>M.value&&a.value;function E(){M.value=!document.hidden}function $(){d.value&&(b.value=new IntersectionObserver(n=>{a.value=n[0].isIntersecting},{threshold:.1}),b.value.observe(d.value))}const N=ee(()=>{const n=v.currentExperiment;if(!n)return!0;const i=n.status;return i==="stopped"||i==="inactive"||!i});async function K(n){var C;if(!R()){c("Cannot run checks while page/component is not visible",{type:"warning",autoClose:1e4});return}if(!N.value){const p=((C=v.currentExperiment)==null?void 0:C.status)||"unknown";c(`Cannot run checks while experiment is ${p}. Please wait for experiment to fully stop.`,{type:"warning",autoClose:1e4});return}const i=_.value.find(p=>p.id===n);i.loading=!0;try{n==="experiment_timing"?await k(i):n==="stock"?await F(i):n==="od"?await S(i):n==="current_od"?await j(i):n==="volume"?await L(i):n==="waste"?await Z(i):n==="pump1"?await q(i):n==="pump_calibration"?await re(i):n==="stirrer_calibration"&&await Y(i)}finally{i.loading=!1}}async function F(n){var l;await new Promise(u=>setTimeout(u,1500));const i=(l=v.currentExperiment)==null?void 0:l.parameters,C=i.stock_concentration_drug,g=Object.values(i.cultures).map(u=>u.pump2_stock_drug_concentration).every(u=>u===C);n.status=g?"passed":"failed",c(n.status==="passed"?"Stock concentrations verified":"Stock concentration mismatch detected",{type:n.status==="passed"?"success":"error",autoClose:1e4})}async function S(n){n.details="",await m.fetchDeviceData();const i=m.ods.calibration,C=[],p=[];if(!i){n.status="failed",c.error("OD calibration data not found. Please run a calibration.",{type:"error"});return}for(let l=1;l<=7;l++){const u=i[l],f=u?u["0.0"]??u[0]:void 0;if(f==null){C.push({vial:l,value:"N/A"});continue}f<15?C.push({vial:l,value:f}):f<20?p.push({vial:l,value:f}):f>150&&C.push({vial:l,value:f})}let g="";C.length>0?(n.status="failed",g+=C.map(l=>`<span class="od-value red">Vial ${l.vial}: ${typeof l.value=="number"?l.value.toFixed(1)+"mV":l.value}</span>`).join(""),c.error(`OD calibration failed for vials: ${C.map(l=>l.vial).join(", ")}`,{type:"error"})):p.length>0?(n.status="warning",c.warning(`OD calibration warning for vials: ${p.map(l=>l.vial).join(", ")}`,{type:"warning"})):(n.status="passed",c("OD calibration verified",{type:"success",autoClose:1e4})),p.length>0&&(g+=p.map(l=>`<span class="od-value yellow">Vial ${l.vial}: ${l.value.toFixed(1)}mV</span>`).join("")),g&&(n.details=`<div class="od-values-grid">${g}</div>`)}async function j(n){var f,r;n.details="";try{const s=[1,2,3,4,5,6,7];for(const w of s)try{await m.measureODs([w]),await new Promise(h=>setTimeout(h,50))}catch(h){if(console.warn(`Failed to measure OD for vial ${w}:`,h),console.log("Full vialError object:",{message:h.message,response:h.response,status:(f=h.response)==null?void 0:f.status,data:(r=h.response)==null?void 0:r.data}),h.response&&h.response.status===500||h.response&&h.response.data&&h.response.data.detail&&h.response.data.detail.includes("Device not initialized")||h.message&&h.message.includes("500")||h.message==="Network Error"||h.code==="ERR_NETWORK"||!h.response&&h.message){n.status="failed",n.details=`<span class="od-value red">
            <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
            Error - Device disconnected. Please check device connection and try again.
          </span>`,c("Error - Device disconnected. Check device connection.",{type:"error",autoClose:1e4}),console.log("Device disconnection error detected:",h);return}}}catch(s){s.response&&s.response.status===500||s.response&&s.response.data&&s.response.data.detail&&s.response.data.detail.includes("Device not initialized")||s.message&&s.message.includes("500")||s.message==="Network Error"||s.code==="ERR_NETWORK"||!s.response&&s.message?(n.status="failed",n.details=`<span class="od-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Error - Device disconnected. Please check device connection and try again.
      </span>`,c("Error - Device disconnected. Check device connection.",{type:"error"}),console.log("Device disconnection error detected:",s)):(n.status="failed",n.details=`<span class="od-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Failed to measure current ODs. Check device connection.
      </span>`,c("Failed to measure current ODs. Check device connection.",{type:"error"})),console.error(s);return}const i=m.ods.states,C=[1,2,3,4,5,6,7],p=[],g=[],l=C.map(s=>{const w=i[s];let h="",o="";w==null?(h="mdi-help-circle",o="grey"):w<-.03?(h="mdi-close-circle",o="red",p.push({vial:s,value:w})):w>.03?(h="mdi-alert-circle",o="yellow",g.push({vial:s,value:w})):(h="mdi-check-circle",o="green");const V=w!=null?w.toFixed(3):"N/A";return`<span class="od-value ${o}">
              <i class="v-icon mdi ${h}" style="font-size: 16px; vertical-align: middle;"></i> 
              Vial ${s}: ${V}
            </span>`}).join("");n.details=`<div class="od-values-grid">${l}</div>`;let u="";p.length>0?(n.status="failed",u+="<b>Error:</b> One or more vials have a very low OD reading (&lt; -0.03). This suggests a calibration issue. Please perform an OD calibration.",c.error(`OD check failed for vials: ${p.map(s=>s.vial).join(", ")}`,{type:"error"})):g.length>0?(n.status="warning",u+="<br/><br/><b>Warning:</b> One or more vials have a positive OD reading (&gt; 0.03). This is acceptable if you are resuming a previous experiment, but new experiments should start with zeroed ODs.",c.warning(`Positive OD detected for vials: ${g.map(s=>s.vial).join(", ")}`,{type:"warning"})):(n.status="passed",u+="<br/><br/><b>Passed:</b> All vial ODs are close to zero, which is ideal for starting a new experiment.",c.success("Current OD values verified.",{type:"success"})),n.tooltip=u}async function L(n){var C;n.details="",n.status="pending",c("Running 24h simulation for volume check...",{type:"info"});const i=(C=v.currentExperiment)==null?void 0:C.parameters;if(!i){n.status="failed",c("No experiment parameters found",{type:"error"});return}try{const p=[],g=[];for(let U=1;U<=7;U++)try{const J=await m.runSimulation(U,24);p.push({vial_id:U,...J.summary_data})}catch(J){console.error(`Vial ${U} simulation failed:`,J),g.push(U)}if(p.length===0){n.status="failed",n.details=`<span class="simulation-volume-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        All vials failed to simulate - check experiment parameters and device connection
      </span>`,c("Failed to fetch simulation data for volume calculation",{type:"error"});return}const l=p.reduce((U,J)=>U+J.pump1_volume_used,0),u=p.reduce((U,J)=>U+J.pump2_volume_used,0),f=p.reduce((U,J)=>U+J.waste_medium_volume_created,0),r=Number(i.stock_volume_drug)||0,s=Number(i.stock_volume_main)||0,w=Number(i.bottle_volume_waste)||0,h=Number(i.stock_volume_waste)||0,o=w-h,V=u<=r,H=l<=s,te=f<=o;let ne="";const le=[];if(V||(le.push(`Drug: need ${u.toFixed(1)}mL, have ${r}mL`),ne+=`<span class="simulation-volume-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Drug bottle: need ${u.toFixed(1)}mL, have ${r}mL (${(u-r).toFixed(1)}mL short)
      </span>`),H||(le.push(`Media: need ${l.toFixed(1)}mL, have ${s}mL`),ne+=`<span class="simulation-volume-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Main bottle: need ${l.toFixed(2)}mL, have ${s.toFixed(2)}mL (${(l-s).toFixed(2)}mL short)
      </span>`),te||(le.push(`Waste: need ${f.toFixed(1)}mL, only ${o.toFixed(1)}mL available`),ne+=`<span class="simulation-volume-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Waste bottle: need ${f.toFixed(1)}mL space, only ${o.toFixed(1)}mL available (${(f-o).toFixed(1)}mL overflow)
      </span>`),g.length>0&&(ne+=`<span class="simulation-volume-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Failed simulations: Vial${g.length>1?"s":""} ${g.join(", ")} - check parameters
      </span>`),ne&&(n.details=`<div class="simulation-volume-grid">${ne}</div>`),V&&H&&te&&g.length===0)n.status="passed",c(`Stock volumes sufficient. Drug: ${u.toFixed(1)}/${r}mL, Media: ${l.toFixed(1)}/${s}mL, Waste: ${f.toFixed(1)}/${o.toFixed(1)}mL available`,{type:"success"});else if(g.length>0&&le.length===0)n.status="warning",c(`Simulation warnings: ${g.length} vial(s) failed but volumes are sufficient for others`,{type:"warning"});else{n.status="failed";const U=[...le];g.length>0&&U.push(`${g.length} vial(s) failed simulation`),c(`Volume issues. ${U.join(", ")}`,{type:"error"})}}catch(p){n.status="failed",n.details=`<span class="simulation-volume-value red">
      <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
      Simulation error: ${p.message||"Unknown error"}
    </span>`,c("Simulation failed: "+(p.message||"Unknown error"),{type:"error"})}}async function Z(n){var r;await new Promise(s=>setTimeout(s,300));const i=(r=v.currentExperiment)==null?void 0:r.parameters;if(!i){n.status="failed",c("No experiment parameters found",{type:"error"});return}const C=Number(i.stock_volume_main)||0,p=Number(i.stock_volume_drug)||0,g=Number(i.bottle_volume_waste)||0,l=Number(i.stock_volume_waste)||0,u=g-l,f=C+p;f<=u?(n.status="passed",c(`Waste capacity sufficient. Current stocks: ${f.toFixed(1)}mL, Available waste space: ${u.toFixed(1)}mL`,{type:"success"})):(n.status="warning",c(`Warning: Current stock volumes (${f.toFixed(1)}mL) exceed available waste space (${u.toFixed(1)}mL). Overflow may occur.`,{type:"warning"}))}async function q(n){var p;await new Promise(g=>setTimeout(g,500));const i=(p=v.currentExperiment)==null?void 0:p.parameters;if(!i||!i.cultures){n.status="failed",c("No experiment parameters or cultures found",{type:"error"});return}const C=[];for(let g=1;g<=7;g++){const l=i.cultures[g];if(l){const u=l.pump1_stock_drug_concentration||0;u!==0&&C.push(`Vial ${g}: ${u}`)}}C.length>0?(n.status="failed",c(`Pump1 concentration not zero in: ${C.join(", ")}`,{type:"error"})):(n.status="passed",c("All vials have pump1 concentration set to zero",{type:"success"}))}async function re(n){n.details="",await m.fetchDeviceData();const i=m.pumps;if(!i||!i.calibration){n.status="failed",c("Pump calibration data not found. Please run pump calibration.",{type:"error"});return}const C=[1,2,4],p={1:"MAIN",2:"DRUG",4:"WASTE"},g=[],l=[];let u="";for(const f of C){const r=i.calibration[f];if(!r||Object.keys(r).length===0){g.push(`${p[f]} (no calibration data)`),u+=`<span class="pump-calibration-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        ${p[f]}: Missing calibration data - please calibrate this pump
      </span>`;continue}const s=Object.entries(r).map(([o,V])=>[parseInt(o),parseFloat(V)]).sort((o,V)=>o[0]-V[0]);if(s.length<2){l.push(`${p[f]} (insufficient data points)`),u+=`<span class="pump-calibration-value yellow">
        <i class="v-icon mdi mdi-alert-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        ${p[f]}: Only ${s.length} calibration point(s) - need at least 2 to check monotonicity
      </span>`;continue}let w=!0;const h=[];for(let o=1;o<s.length;o++){const V=s[o-1],H=s[o];H[1]>V[1]&&(w=!1,h.push(`${H[0]} rots pumps MORE than ${V[0]} rots (${H[1].toFixed(3)} vs ${V[1].toFixed(3)} ml/rot)`))}w||(g.push(`${p[f]} (non-monotonic)`),u+=`<span class="pump-calibration-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        ${p[f]}: Invalid calibration - ${h.join("; ")}
      </span>`)}u&&(n.details=`<div class="pump-calibration-grid">${u}</div>`),g.length>0?(n.status="failed",c(`Pump calibration monotonicity failed for: ${g.join(", ")}`,{type:"error"})):l.length>0?(n.status="warning",c(`Pump calibration warnings for: ${l.join(", ")}`,{type:"warning"})):(n.status="passed",c("All pump calibrations are monotonically correct",{type:"success"}))}async function Y(n){n.details="",await m.fetchDeviceData();const i=m.stirrers;if(!i||!i.calibration){n.status="failed",c("Stirrer calibration data not found. Please run stirrer calibration.",{type:"error"});return}const C=[1,2,3,4,5,6,7],p=[];let g="";for(const l of C){const u=i.calibration[l];if(!u||typeof u!="object"){p.push(`Stirrer ${l} (no calibration data)`),g+=`<span class="stirrer-calibration-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Stirrer ${l}: Missing calibration data - please calibrate this stirrer
      </span>`;continue}const{high:f,low:r}=u;if(f==null||r===void 0||r===null){p.push(`Stirrer ${l} (incomplete calibration)`),g+=`<span class="stirrer-calibration-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Stirrer ${l}: Incomplete calibration data (high: ${f}, low: ${r})
      </span>`;continue}f<=r&&(p.push(`Stirrer ${l} (high ≤ low)`),g+=`<span class="stirrer-calibration-value red">
        <i class="v-icon mdi mdi-close-circle" style="font-size: 16px; vertical-align: middle;"></i> 
        Stirrer ${l}: High speed (${f.toFixed(3)}) must be greater than low speed (${r.toFixed(3)})
      </span>`)}g&&(n.details=`<div class="stirrer-calibration-grid">${g}</div>`),p.length>0?(n.status="failed",c(`Stirrer calibration failed for: ${p.join(", ")}`,{type:"error"})):(n.status="passed",c("All stirrer calibrations are correct (high > low)",{type:"success"}))}async function fe(){var n;if(!R()){c("Cannot run checks while page/component is not visible",{type:"warning"});return}if(!N.value){const i=((n=v.currentExperiment)==null?void 0:n.status)||"unknown";c(`Cannot run checks while experiment is ${i}. Please wait for experiment to fully stop.`,{type:"warning"});return}y.value=!0;try{for(const l of _.value)await K(l.id);const i=_.value.filter(l=>l.status==="passed").length,C=_.value.filter(l=>l.status==="failed").length,p=_.value.filter(l=>l.status==="warning").length,g=_.value.length;if(C===0&&p===0)c(`All ${g} checks passed! Experiment ready to start.`,{type:"success",autoClose:1e4});else if(C===0&&p>0)c(`${i} checks passed, ${p} warning(s). Review warnings before starting.`,{type:"warning"});else if(C>0){const l=[];C>0&&l.push(`${C} failed`),p>0&&l.push(`${p} warning(s)`),c(`${i}/${g} checks passed, ${l.join(", ")}. Review issues before starting.`,{type:"warning"})}else c(`All ${g} checks failed. Address issues before starting experiment.`,{type:"error"})}catch(i){c("Error running checks: "+(i.message||"Unknown error"),{type:"error"})}finally{y.value=!1}}return pe(()=>{document.addEventListener("visibilitychange",E),$(),M.value=!document.hidden}),Ve(()=>{document.removeEventListener("visibilitychange",E),b.value&&b.value.disconnect()}),e({checks:_,isPageVisible:M,isComponentVisible:a,shouldAllowUpdates:R}),(n,i)=>{const C=z("v-btn"),p=z("v-chip"),g=z("v-tooltip"),l=z("v-table");return T(),P("div",{class:"experiment-checks",ref_key:"checksContainer",ref:d},[O(l,null,{default:W(()=>[D("thead",null,[D("tr",null,[D("th",null,[O(C,{color:"primary",onClick:fe,loading:y.value,disabled:_.value.some(u=>u.loading)||!N.value,size:"small"},{default:W(()=>i[0]||(i[0]=[A(" Verify All ")])),_:1},8,["loading","disabled"])]),i[1]||(i[1]=D("th",null,"Status",-1)),i[2]||(i[2]=D("th",null,"Pre-experiment Checks",-1))])]),D("tbody",null,[(T(!0),P(de,null,me(_.value,u=>(T(),P("tr",{key:u.id},[D("td",null,[O(C,{size:"small",onClick:f=>K(u.id),loading:u.loading,disabled:u.loading||!N.value},{default:W(()=>i[3]||(i[3]=[A(" Verify ")])),_:2},1032,["onClick","loading","disabled"])]),D("td",null,[O(p,{color:x(u.status),size:"small"},{default:W(()=>[A(X(B(u.status)),1)]),_:2},1032,["color"])]),D("td",null,[O(g,{location:"top"},{activator:W(({props:f})=>[D("div",De({ref_for:!0},f),[D("span",null,X(u.name),1),u.details?(T(),P("div",{key:0,innerHTML:u.details,class:"od-details-container"},null,8,Ye)):G("",!0)],16)]),default:W(()=>[D("div",{innerHTML:u.tooltip},null,8,Ge)]),_:2},1024)])]))),128))])]),_:1})],512)}}},Je=se(Ze,[["__scopeId","data-v-b09c593f"]]);const Qe={class:"experiment-setup"},et={class:"d-flex line-container"},tt={class:"d-flex line-container"},nt={key:0,class:"new-experiment-form"},at={class:"form-header"},it={class:"form-note"},st={class:"form-content"},ot={class:"form-input-row"},rt={key:2},lt={__name:"ExperimentSetup",setup(t){const e=oe(),{openDialog:v}=Se(),m=I(""),y=I(!1),d=I(null),M=I(null),a=I(!1),b=I(!0),_=ee(()=>e.experiments),x=ee(()=>e.currentExperiment||{}),B=ee(()=>[..._.value].reverse());async function k(){x.value.status==="running"&&await e.stopExperiment(),await e.selectExperiment(d.value)}async function R(){y.value=!y.value,x.value.status==="running"&&await e.stopExperiment()}async function E(){if(!m.value||m.value.trim()===""){c("Experiment name cannot be empty",{type:"error"});return}const F=m.value.trim();if(/[<>:"/\\|?*\x00-\x1f]/.test(F)){c('Experiment name contains invalid characters. Avoid: < > : " / \\ | ? *',{type:"error"});return}if(/^(CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])$/i.test(F)){c("Experiment name cannot be a reserved system name",{type:"error"});return}if(F.startsWith(".")||F.endsWith(".")||F.endsWith(" ")){c("Experiment name cannot start or end with dots or spaces",{type:"error"});return}if(F.length>255){c("Experiment name is too long (maximum 255 characters)",{type:"error"});return}try{d.value=await e.createExperiment({name:F}),await e.selectExperiment(d.value),y.value=!1,m.value=x.value.name,c(`New experiment "${F}" created`,{type:"success"})}catch(L){c(L.message||"Failed to create experiment",{type:"error"})}}function $(){return!x.value||x.value.id===0?"Default Template":x.value.name||"Default Template"}async function N(){if(M.value){const F=M.value.checks,S=F.filter(L=>L.status==="failed"),j=F.filter(L=>L.status==="pending");if(S.length>0||j.length>0){S.map(q=>q.name),j.map(q=>q.name);let L="";if(S.length>0&&j.length>0?L="Some checks failed and some are pending.":S.length>0?L="Some checks failed.":L="Some checks are pending.",L+=`

Start experiment anyway?`,!await v({title:"Pre-experiment Checks Warning",message:L}))return}}try{await e.startExperiment(),await e.fetchCurrentExperiment(),c("Experiment started!",{type:"success"})}catch(F){c(F.message,{type:"error"})}}async function K(){var F;console.log("Stop experiment clicked, setting loading to true"),a.value=!0;try{console.log("Calling experimentStore.stopExperiment()"),await e.stopExperiment(),console.log("Stop experiment request sent, polling for actual status change");let S=0;const j=30;for(;S<j;){await new Promise(Z=>setTimeout(Z,1e3)),await e.fetchCurrentExperiment();const L=(F=e.currentExperiment)==null?void 0:F.status;if(console.log(`Polling attempt ${S+1}: status = ${L}`),L==="stopped"||L==="inactive"||!L){console.log("Experiment confirmed stopped"),c("Experiment stopped!",{type:"success"});return}L==="stopping"&&console.log("Experiment still stopping, continuing to poll..."),S++}console.warn("Stop polling timed out, but experiment may have stopped"),c("Stop command sent, but status confirmation timed out",{type:"warning"})}catch(S){console.error("Error stopping experiment:",S),c(S.message||"Failed to stop experiment",{type:"error"})}finally{console.log("Setting loading to false"),a.value=!1}}return pe(async()=>{try{await e.fetchExperiments(),await e.fetchCurrentExperiment(),e.currentExperiment&&(d.value=e.currentExperiment.id)}finally{b.value=!1}}),(F,S)=>{const j=z("v-select"),L=z("v-btn"),Z=z("v-icon"),q=z("v-text-field"),re=z("v-container");return T(),ie(re,null,{default:W(()=>[D("div",Qe,[D("div",et,[O(j,{modelValue:d.value,"onUpdate:modelValue":[S[0]||(S[0]=Y=>d.value=Y),k],items:B.value,"item-title":"name","item-value":"id",label:"Select Experiment",dense:"",outlined:"",class:"flex-grow-1 mt-3 experiment-select",style:{minWidth:"150px"},disabled:x.value.status==="running"||x.value.status==="stopping"||b.value,loading:b.value},null,8,["modelValue","items","disabled","loading"]),O(L,{color:"primary",onClick:R,class:"mt-3",style:{height:"60px"},title:"New Experiment",disabled:x.value.status==="running"||x.value.status==="stopping"||b.value,loading:b.value},{default:W(()=>S[3]||(S[3]=[A("+")])),_:1},8,["disabled","loading"])]),D("div",tt,[O(L,{class:ge(["start-button",{active:x.value.status==="running"}]),style:ae({"background-color":x.value.status==="running"?"#28a745":"transparent",opacity:x.value.status==="running"?.5:1}),onClick:N,color:"success",title:"Start the experiment loop - measure OD every minute and dilute the cultures as necessary, according to the parameters.",disabled:x.value.status==="running"||x.value.status==="stopping"||b.value,loading:b.value},{default:W(()=>S[4]||(S[4]=[A(" Start ")])),_:1},8,["class","style","disabled","loading"]),O(L,{class:ge(["start-button",{active:x.value.status==="stopped"}]),style:ae({"background-color":x.value.status==="stopped"?"#dc3545":"transparent",opacity:x.value.status==="stopped"?.5:1}),onClick:K,color:"error",title:"Stop gracefully - wait for the current dilution to finish.",disabled:x.value.status==="stopped"||x.value.status==="stopping"||a.value||b.value,loading:a.value},{default:W(()=>S[5]||(S[5]=[A(" Stop ")])),_:1},8,["class","style","disabled","loading"])]),y.value?(T(),P("div",nt,[D("div",at,[D("div",it,[S[6]||(S[6]=A(" New experiment will copy parameters from ")),D("strong",null,X($()),1)]),O(L,{icon:"",size:"small",onClick:S[1]||(S[1]=Y=>y.value=!1),class:"close-btn",title:"Close"},{default:W(()=>[O(Z,{size:"18"},{default:W(()=>S[7]||(S[7]=[A("mdi-close")])),_:1})]),_:1})]),D("div",st,[D("div",ot,[O(q,{modelValue:m.value,"onUpdate:modelValue":S[2]||(S[2]=Y=>m.value=Y),label:"New Experiment Name",outlined:"",dense:"",class:"flex-grow-1",onKeyup:Q(E,["enter"])},null,8,["modelValue"]),O(L,{color:"primary",onClick:E,class:"ml-3 create-btn"},{default:W(()=>S[8]||(S[8]=[A("Create Experiment")])),_:1})])])])):G("",!0),x.value&&x.value.id&&x.value.id!==0&&x.value.status!=="running"?(T(),ie(Je,{key:1,ref_key:"experimentChecks",ref:M},null,512)):G("",!0),x.value&&x.value.id&&x.value.id!==0?(T(),P("div",rt,[O(Xe)])):G("",!0)])]),_:1})}}},ut=se(lt,[["__scopeId","data-v-04512f79"]]);const ct=Me({components:{TableComponent:Ne},setup(){const t=oe(),e=Ee(),v=I(!1),m=I(null),y=I(null),d=I(0),M=I(new Date),a=I(null),b=I(!0),_=I(!0),x=I(null),B=I(null),k=I([]),R=["Last OD","OD Timestamp","Growth Rate (1/h)","RPM (1h)","Current Concentration","Medium Used (1h)","Medium Used (24h)","Drug Used (1h)","Drug Used (24h)","Total Dilutions","Last Dilution","Runtime"],E={"Last OD":"Most recent optical density measurement","OD Timestamp":"Time when the last OD measurement was taken","Growth Rate (1/h)":"Current growth rate (mu)","RPM (1h)":"Average stirrer speed over the last hour (mean ± standard deviation)","Current Concentration":"Current drug concentration in the culture","Medium Used (1h)":"Volume of pump1 medium growth medium consumed in the last hour","Medium Used (24h)":"Volume of pump1 medium consumed in the last 24 hours","Drug Used (1h)":"Volume of pump2 medium (drug) consumed in the last hour","Drug Used (24h)":"Volume of pump2 medium (drug) consumed in the last 24 hours","Total Dilutions":"Total number of dilution events since experiment start","Last Dilution":"Most recent dilution event",Runtime:"Time between first and last OD measurements"},$=I({show:!1,text:"",x:0,y:0});function N(){k.value=R.map(()=>Array(8).fill("—"))}function K(){const r=[5,6,7,8,9];for(const w of r){let h=0,o=!1;for(let V=0;V<7;V++){const H=k.value[w][V];if(H!=="—"){const te=parseFloat(H.toString().replace(/[^\d.-]/g,""));isNaN(te)||(h+=te,o=!0)}}if(o)if(w===9)k.value[w][7]=h.toString();else{const V="mL";k.value[w][7]=`${h.toFixed(2)} ${V}`}else k.value[w][7]="—"}const s=[0,1,2,3,4,10,11];for(const w of s)k.value[w][7]="—"}async function F(){return{data:k.value,keys:R}}async function S(r){console.log("Summary table is read-only")}function j(r){var w;const s=r.target.closest(".rgCell");if(s){const h=(w=s.textContent)==null?void 0:w.trim();if(h&&E[h]){const o=s.getBoundingClientRect(),V=B.value.getBoundingClientRect();$.value={show:!0,text:E[h],x:o.left-V.left,y:o.top-V.top-40}}}}function L(){$.value.show=!1}function Z(r){if(!r)return"";const s=M.value,w=new Date(r),h=Math.max(0,Math.floor((s-w)/1e3));if(h<60)return`${h} seconds ago`;if(h<3600){const o=Math.floor(h/60);return`${o} minute${o!==1?"s":""} ago`}else{const o=Math.floor(h/3600);return`${o} hour${o!==1?"s":""} ago`}}async function q(){v.value=!0;try{await re(),m.value=new Date}catch(r){console.error("Failed to refresh summary data:",r),c.error(`Failed to refresh summary data: ${r.message||"Unknown error"}`)}finally{v.value=!1}}async function re(){if(t.currentExperiment)try{const s=await t.fetchExperimentSummary();await e.fetchDeviceData(),await t.fetchCurrentExperiment(),k.value.length===0&&N();for(let w=1;w<=7;w++){const h=`vial${w}`,o=s[h],V=w-1;if(o){if(k.value[0][V]=o.last_od!==null&&o.last_od!==void 0?o.last_od.toFixed(3):"—",k.value[1][V]=o.od_timestamp?new Date(o.od_timestamp).toLocaleTimeString():"—",k.value[2][V]=o.growth_rate!==null&&o.growth_rate!==void 0?o.growth_rate.toFixed(3):"—",o.rpm_mean_1h!==null&&o.rpm_mean_1h!==void 0){const H=o.rpm_mean_1h.toFixed(0),te=o.rpm_std_1h!==null?o.rpm_std_1h.toFixed(0):"0";k.value[3][V]=`${H} ± ${te}`}else k.value[3][V]="—";k.value[4][V]=o.current_concentration!==null&&o.current_concentration!==void 0?o.current_concentration.toFixed(3):"—",k.value[5][V]=o.medium_used_1h!==null&&o.medium_used_1h!==void 0?`${o.medium_used_1h.toFixed(2)} mL`:"—",k.value[6][V]=o.medium_used_24h!==null&&o.medium_used_24h!==void 0?`${o.medium_used_24h.toFixed(2)} mL`:"—",k.value[7][V]=o.drug_used_1h!==null&&o.drug_used_1h!==void 0?`${o.drug_used_1h.toFixed(2)} mL`:"—",k.value[8][V]=o.drug_used_24h!==null&&o.drug_used_24h!==void 0?`${o.drug_used_24h.toFixed(2)} mL`:"—",k.value[9][V]=o.total_dilutions||"—",k.value[10][V]=o.last_dilution||"—",k.value[11][V]=o.runtime||"—"}else for(let H=0;H<12;H++)k.value[H][V]="—"}K(),d.value+=1}catch(s){throw console.error("Error fetching experiment summary:",s),s}}const Y=()=>b.value&&_.value,fe=()=>{const r=t.currentExperiment;if(!r)return!1;const s=r.status==="running",w=Y();return s&&w};function n(){b.value=!document.hidden}function i(){B.value&&(x.value=new IntersectionObserver(r=>{_.value=r[0].isIntersecting},{threshold:.1}),x.value.observe(B.value))}function C(){y.value=setInterval(()=>{if(fe())q();else{const r=t.currentExperiment,s=(r==null?void 0:r.status)||"no experiment",w=Y()?"visible":"not visible";console.log(`ExperimentSummary: Skipping auto-refresh - experiment ${s}, component ${w}`)}},3e4)}function p(){y.value&&(clearInterval(y.value),y.value=null)}function g(){a.value=setInterval(()=>{M.value=new Date},1e3)}function l(){a.value&&(clearInterval(a.value),a.value=null)}const u=ee(()=>m.value?Z(m.value):""),f=ee(()=>{const r=R.length,s=32,w=55,h=40,o=50,V=20;return r*s+w+h+o+V});return Te(()=>{var r;return(r=t.currentExperiment)==null?void 0:r.id},(r,s)=>{r!==s&&(console.log("Experiment changed, refreshing summary table"),N(),d.value+=1,q())},{immediate:!1}),pe(()=>{if(N(),q(),C(),g(),document.addEventListener("visibilitychange",n),i(),b.value=!document.hidden,B.value){const r=B.value.querySelector(".table-container");r&&r.addEventListener("wheel",s=>{s.deltaX!==0?(s.preventDefault(),r.scrollLeft+=s.deltaX):s.shiftKey&&s.deltaY!==0&&(s.preventDefault(),r.scrollLeft+=s.deltaY)},{passive:!1})}}),Ve(()=>{p(),l(),document.removeEventListener("visibilitychange",n),x.value&&x.value.disconnect()}),{loading:v,lastUpdated:m,fetchTableData:F,updateTableData:S,formatTime:Z,refreshData:q,toast:c,tableKey:d,lastUpdatedText:u,containerHeight:f,summaryContainer:B,isPageVisible:b,isComponentVisible:_,shouldAllowUpdates:Y,tooltip:$,handleTableMouseOver:j,handleTableMouseOut:L}}}),dt={class:"refresh-controls"},mt={class:"last-updated"};function pt(t,e,v,m,y,d){const M=z("TableComponent"),a=z("v-icon"),b=z("v-btn");return T(),P("div",{class:"experiment-summary-container",ref:"summaryContainer",style:ae({minHeight:t.containerHeight+"px"})},[D("h2",null,[e[3]||(e[3]=A(" Experiment Summary ")),D("span",{class:"info-icon",onClick:e[0]||(e[0]=_=>t.toast.info("Live experiment data summary with auto-refresh every 30 seconds.",{position:"top-right",autoClose:8e3})),style:{cursor:"pointer","margin-left":"8px","font-size":"0.8em"}}," ⓘ ")]),D("div",{class:"table-container",onMouseover:e[1]||(e[1]=(..._)=>t.handleTableMouseOver&&t.handleTableMouseOver(..._)),onMouseout:e[2]||(e[2]=(..._)=>t.handleTableMouseOut&&t.handleTableMouseOut(..._))},[(T(),ie(M,{key:t.tableKey,fetchData:t.fetchTableData,updateData:t.updateTableData,columnHeaders:["Vial 1","Vial 2","Vial 3","Vial 4","Vial 5","Vial 6","Vial 7","Total"],rowHeaderLabel:"Metric",rowHeaderWidth:200,readonly:!0,fixedRows:12},null,8,["fetchData","updateData"])),t.tooltip.show?(T(),P("div",{key:0,class:"custom-tooltip",style:ae({top:t.tooltip.y+"px",left:t.tooltip.x+"px"})},X(t.tooltip.text),5)):G("",!0)],32),D("div",dt,[O(b,{color:"primary",size:"small",loading:t.loading,onClick:t.refreshData},{default:W(()=>[O(a,{left:""},{default:W(()=>e[4]||(e[4]=[A("mdi-refresh")])),_:1}),e[5]||(e[5]=A(" Refresh "))]),_:1},8,["loading","onClick"]),D("span",mt,X(t.lastUpdated?`Last updated: ${t.lastUpdatedText}`:""),1)])],4)}const ft=se(ct,[["render",pt],["__scopeId","data-v-f2b85e3c"]]);const vt={id:"CulturePlot"},gt={class:"control-container"},ht={class:"button-row"},yt={class:"button-container"},bt={__name:"ExperimentChart",setup(t){const e=oe(),{currentExperiment:v,selectedVials:m,plot_data:y}=$e(e),d=[1,2,3,4,5,6,7],M=ee(()=>d.filter(_=>m.value[_]));async function a(){if(v.value)for(let _ of M.value)await e.fetchCulturePlot(_)}async function b(_,x){let B;x.altKey?B={[_]:!0}:B={...m.value,[_]:!m.value[_]},e.setSelectedVials(B),B[_]&&await e.fetchCulturePlot(_)}return pe(()=>{a()}),(_,x)=>{const B=z("v-btn");return T(),P("div",vt,[D("div",gt,[D("div",ht,[O(B,{class:"plot-button",color:"success",onClick:a,title:"Plot selected vials. alt-click to select single vial"},{default:W(()=>x[0]||(x[0]=[A("Plot Data")])),_:1}),D("div",yt,[(T(),P(de,null,me(d,k=>D("div",{key:k,class:"button-item"},[O(B,{color:ve(m)[k]?"primary":"secondary",style:ae({"background-color":ve(m)[k]?"#007bff":"transparent"}),onClick:R=>b(k,R),id:`vial-button-${k}`},{default:W(()=>[A(X(`Vial ${k}`),1)]),_:2},1032,["color","style","onClick","id"])])),64))])])]),(T(!0),P(de,null,me(M.value,k=>(T(),P("div",{key:k},[O(Le,{vial:k,data:ve(y)[k]},null,8,["vial","data"])]))),128))])}}},xt=se(bt,[["__scopeId","data-v-9ef9e3fb"]]),$t={__name:"ExperimentTab",setup(t){const e=oe(),{experiments:v,currentExperiment:m,errorMessage:y}=$e(e),d=ee(()=>{var a,b;return Object.keys(((b=(a=m.value)==null?void 0:a.parameters)==null?void 0:b.cultures)||{}).length>0});return(M,a)=>(T(),P("div",null,[O(ut),d.value?(T(),ie(ft,{key:0})):G("",!0),d.value?(T(),ie(xt,{key:1})):G("",!0)]))}};export{$t as default};
