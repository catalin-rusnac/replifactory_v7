import{z as Ee,N as Pe,J as ke,O as ot,k as F,m as ie,p as Me,A as se,P as De,L as pe,Q as Fe,_ as Y,B as ne,h as H,o,c as v,a as r,F as q,i as Q,t as T,e as j,w as ce,v as de,j as X,C as I,d as N,R as fe,S as ve,r as U,q as E,f as h,s as R,l as W,M as st,T as it,U as rt,n as Oe,b as re,y as we,g as ut}from"./index-bda44a6a.js";import{u as le}from"./device-f3c30d62.js";import{C as me,B as ct,S as dt,a as vt,b as Ae,L as Re,p as Le,c as Ue,d as Ne,e as pt,P as ft}from"./chart-48157de6.js";/* empty css              */const Te={data:{type:Object,required:!0},options:{type:Object,default:()=>({})},plugins:{type:Array,default:()=>[]},datasetIdKey:{type:String,default:"label"},updateMode:{type:String,default:void 0}},mt={ariaLabel:{type:String},ariaDescribedby:{type:String}},gt={type:{type:String,required:!0},destroyDelay:{type:Number,default:0},...Te,...mt},bt=ot[0]==="2"?(g,n)=>Object.assign(g,{attrs:n}):(g,n)=>Object.assign(g,n);function ue(g){return Fe(g)?De(g):g}function _t(g){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:g;return Fe(n)?new Proxy(g,{}):g}function yt(g,n){const e=g.options;e&&n&&Object.assign(e,n)}function Be(g,n){g.labels=n}function qe(g,n,e){const S=[];g.datasets=n.map(b=>{const s=g.datasets.find(D=>D[e]===b[e]);return!s||!b.data||S.includes(s)?{...b}:(S.push(s),Object.assign(s,b),s)})}function ht(g,n){const e={labels:[],datasets:[]};return Be(e,g.labels),qe(e,g.datasets,n),e}const Ct=Ee({props:gt,setup(g,n){let{expose:e,slots:S}=n;const b=F(null),s=Pe(null);e({chart:s});const D=()=>{if(!b.value)return;const{type:P,data:C,options:c,plugins:p,datasetIdKey:t}=g,_=ht(C,t),y=_t(_,C);s.value=new me(b.value,{type:P,data:y,options:{...c},plugins:p})},k=()=>{const P=De(s.value);P&&(g.destroyDelay>0?setTimeout(()=>{P.destroy(),s.value=null},g.destroyDelay):(P.destroy(),s.value=null))},A=P=>{P.update(g.updateMode)};return ie(D),Me(k),se([()=>g.options,()=>g.data],(P,C)=>{let[c,p]=P,[t,_]=C;const y=De(s.value);if(!y)return;let f=!1;if(c){const x=ue(c),d=ue(t);x&&x!==d&&(yt(y,x),f=!0)}if(p){const x=ue(p.labels),d=ue(_.labels),i=ue(p.datasets),m=ue(_.datasets);x!==d&&(Be(y.config.data,x),f=!0),i&&i!==m&&(qe(y.config.data,i,g.datasetIdKey),f=!0)}f&&pe(()=>{A(y)})},{deep:!0}),()=>ke("canvas",{role:"img",ariaLabel:g.ariaLabel,ariaDescribedby:g.ariaDescribedby,ref:b},[ke("p",{},[S.default?S.default():""])])}});function je(g,n){return me.register(n),Ee({props:Te,setup(e,S){let{expose:b}=S;const s=Pe(null),D=k=>{s.value=k==null?void 0:k.chart};return b({chart:s}),()=>ke(Ct,bt({ref:D},{type:g,...e}))}})}const kt=je("bar",ct),Dt=je("scatter",dt);const wt={class:"pump-data"},St={class:"iteration-rotation-wrapper"},$t={class:"iteration"},xt={class:"rotation"},Ot=["onClick"],It={key:0},Vt={key:1},Et=["onUpdate:modelValue","onChange"],Pt={class:"chart-container"},Mt={key:0,class:"calibration-section"},Ft={__name:"PumpCalibration",props:{pumpId:{type:Number,required:!0}},setup(g){me.register(vt,Ae,Re,Le,Ue,Ne);const n=g,e=le(),{calibrationModeEnabled:S,pumps:b,valves:s}=ne(e),D=F({datasets:[{data:[]}]}),k=F({responsive:!0,devicePixelRatio:4,maintainAspectRatio:!1,plugins:{legend:{display:!1}},backgroundColor:"rgba(0, 140, 186, 0.3)",layout:{padding:{top:20}},scales:{x:{title:{display:!0,text:"rotations"}},y:{title:{display:!0,text:"mL / rotation"},beginAtZero:!1,suggestedMin:.1,suggestedMax:.22}}}),A=F({}),P=F(null),C=F([{rotations:1,iterations:50,total_ml:NaN},{rotations:5,iterations:10,total_ml:NaN},{rotations:10,iterations:5,total_ml:NaN},{rotations:50,iterations:1,total_ml:NaN}]),c=H(()=>{var d,i;return((i=(d=b.value)==null?void 0:d.calibration)==null?void 0:i[n.pumpId])||{}});function p(){return{labels:Object.keys(c.value),datasets:[{label:null,data:Object.values(c.value),fill:!1,borderColor:"rgb(75, 192, 192)",tension:.1}]}}function t(){D.value=p()}function _(d){if(!Object.values(s.value.states).some(m=>m==="open")){alert("At least one valve must be open to start the pump");return}A.value[d]=!A.value[d],A.value[d]?x(C.value[d]):e.setPartStateAction({devicePart:"pumps",partIndex:n.pumpId,newState:"stopped"})}function y(d){A.value[d]=!1}function f(d){d.total_ml&&(e.setPartCalibrationAction({devicePart:"pumps",partIndex:n.pumpId,newCalibration:{...c.value,[d.rotations]:d.total_ml/d.rotations/d.iterations}}),A.value[d]=!1)}async function x(d){if(!confirm(`Pumping ${d.rotations} rotations ${d.iterations} times. Please blank the scale. Continue?`)){const m=C.value.findIndex(u=>u===d);y(m);return}try{const m=Date.now()+Math.random();P.value=m;const u=e.startPumpCalibrationSequence({pumpId:n.pumpId,rotations:d.rotations,iterations:d.iterations});await new Promise(K=>setTimeout(K,100)),await e.fetchDeviceData(),await u;const V=C.value.findIndex(K=>K===d);if(y(V),P.value===m){const K=parseFloat(prompt("Enter total mL pumped"));isNaN(K)||(d.total_ml=K,f(d))}P.value===m&&(P.value=null)}catch(m){console.error("Calibration failed:",m);const u=C.value.findIndex(V=>V===d);y(u),P.value=null}}return ie(()=>{c.value&&t(),C.value.forEach(d=>{d.total_ml=(c.value[d.rotations]||0)*d.rotations*d.iterations,d.total_ml=d.total_ml?d.total_ml.toFixed(2):""})}),se(c,()=>{t()},{deep:!0}),se(()=>{var d,i;return(i=(d=b.value)==null?void 0:d.states)==null?void 0:i[n.pumpId]},(d,i)=>{d==="stopped"&&i==="running"&&(Object.values(A.value).some(Boolean)&&P.value&&(P.value=null),Object.keys(A.value).forEach(u=>{A.value[u]&&(A.value[u]=!1)}))}),(d,i)=>(o(),v("div",wt,[r("table",null,[i[1]||(i[1]=r("thead",null,[r("tr",null,[r("th",null,"Calibration Sequence"),r("th"),r("th",null,"Volume (mL)")])],-1)),r("tbody",null,[(o(!0),v(q,null,Q(C.value,(m,u)=>(o(),v("tr",{key:u},[r("td",null,[r("div",St,[r("div",$t,T(m.iterations),1),i[0]||(i[0]=r("div",{class:"multiplier"},"x",-1)),r("div",xt,T(m.rotations)+" rots",1)])]),r("td",null,[r("button",{onClick:V=>_(u),class:j([A.value[u]?"stop-button":"",A.value[u]===!1&&C.value[u].total_ml?"restart-button":""])},[A.value[u]?(o(),v("span",It,"Stop")):(o(),v("span",Vt,"Start"))],10,Ot)]),r("td",null,[ce(r("input",{"onUpdate:modelValue":V=>m.total_ml=V,onChange:V=>f(m),type:"float"},null,40,Et),[[de,m.total_ml]])])]))),128))])]),r("div",Pt,[D.value.datasets[0].data.length>0?(o(),X(I(kt),{key:0,id:"pump-calibration-chart",options:k.value,class:"pump-calibration-chart",data:D.value},null,8,["options","data"])):N("",!0)]),I(S)?(o(),v("div",Mt)):N("",!0)]))}},At=Y(Ft,[["__scopeId","data-v-23032033"]]);const Rt={__name:"PumpSettingsDialog",props:{modelValue:{type:Boolean,default:!1},pumpId:{type:Number,required:!0},pumpName:{type:String,required:!0}},emits:["update:modelValue","settingsUpdated"],setup(g,{emit:n}){const e=g,S=n,b=F(e.modelValue),s=F(!1),D={max_speed_rps:4,min_speed_rps:.01,acceleration:.01,deceleration:.01,kval_run:.8,kval_acc:.57,kval_dec:.3,stall_threshold:.5},k=fe({...D});se(()=>e.modelValue,p=>{b.value=p,p&&A()}),se(b,p=>{S("update:modelValue",p)});async function A(){try{const p=await ve.get(`/pump/${e.pumpId}/stepper-params`);p.data.success&&Object.assign(k,p.data.params)}catch(p){console.error("Error loading pump settings:",p),Object.assign(k,D)}}async function P(){s.value=!0;try{const p=await ve.post(`/pump/${e.pumpId}/stepper-params`,{params:k});p.data.success?(S("settingsUpdated",{pumpId:e.pumpId,params:{...k}}),c()):alert("Error saving settings: "+(p.data.error||"Unknown error"))}catch(p){console.error("Error saving pump settings:",p),alert("Error saving settings: "+p.message)}finally{s.value=!1}}function C(){Object.assign(k,D)}function c(){b.value=!1}return(p,t)=>{const _=U("v-spacer"),y=U("v-icon"),f=U("v-btn"),x=U("v-card-title"),d=U("v-alert"),i=U("v-text-field"),m=U("v-col"),u=U("v-row"),V=U("v-container"),K=U("v-card-text"),z=U("v-card-actions"),oe=U("v-card"),G=U("v-dialog");return o(),X(G,{modelValue:b.value,"onUpdate:modelValue":t[8]||(t[8]=B=>b.value=B),"max-width":"600px",persistent:""},{default:E(()=>[h(oe,null,{default:E(()=>[h(x,{class:"text-h5"},{default:E(()=>[R(T(g.pumpName)+" Pump Stepper Settings ",1),h(_),h(f,{icon:"",onClick:c},{default:E(()=>[h(y,null,{default:E(()=>t[9]||(t[9]=[R("mdi-close")])),_:1})]),_:1})]),_:1}),h(K,null,{default:E(()=>[h(d,{type:"warning",class:"mb-4"},{default:E(()=>t[10]||(t[10]=[R(" These settings are temporary and will reset to defaults when the device reconnects. ")])),_:1}),h(V,null,{default:E(()=>[h(u,null,{default:E(()=>[h(m,{cols:"12",md:"6"},{default:E(()=>[h(i,{modelValue:k.max_speed_rps,"onUpdate:modelValue":t[0]||(t[0]=B=>k.max_speed_rps=B),modelModifiers:{number:!0},label:"Max Speed (RPS)",type:"number",step:"0.1",min:"0.1",max:"10",hint:"Maximum rotation speed in rotations per second","persistent-hint":""},null,8,["modelValue"])]),_:1}),h(m,{cols:"12",md:"6"},{default:E(()=>[h(i,{modelValue:k.min_speed_rps,"onUpdate:modelValue":t[1]||(t[1]=B=>k.min_speed_rps=B),modelModifiers:{number:!0},label:"Min Speed (RPS)",type:"number",step:"0.01",min:"0.01",max:"1",hint:"Minimum rotation speed in rotations per second","persistent-hint":""},null,8,["modelValue"])]),_:1})]),_:1}),h(u,null,{default:E(()=>[h(m,{cols:"12",md:"6"},{default:E(()=>[h(i,{modelValue:k.acceleration,"onUpdate:modelValue":t[2]||(t[2]=B=>k.acceleration=B),modelModifiers:{number:!0},label:"Acceleration",type:"number",step:"0.001",min:"0.001",max:"1",hint:"Acceleration rate","persistent-hint":""},null,8,["modelValue"])]),_:1}),h(m,{cols:"12",md:"6"},{default:E(()=>[h(i,{modelValue:k.deceleration,"onUpdate:modelValue":t[3]||(t[3]=B=>k.deceleration=B),modelModifiers:{number:!0},label:"Deceleration",type:"number",step:"0.001",min:"0.001",max:"1",hint:"Deceleration rate","persistent-hint":""},null,8,["modelValue"])]),_:1})]),_:1}),h(u,null,{default:E(()=>[h(m,{cols:"12",md:"4"},{default:E(()=>[h(i,{modelValue:k.kval_run,"onUpdate:modelValue":t[4]||(t[4]=B=>k.kval_run=B),modelModifiers:{number:!0},label:"KVAL Run",type:"number",step:"0.01",min:"0",max:"1",hint:"Running voltage (0-1)","persistent-hint":""},null,8,["modelValue"])]),_:1}),h(m,{cols:"12",md:"4"},{default:E(()=>[h(i,{modelValue:k.kval_acc,"onUpdate:modelValue":t[5]||(t[5]=B=>k.kval_acc=B),modelModifiers:{number:!0},label:"KVAL Acceleration",type:"number",step:"0.01",min:"0",max:"1",hint:"Acceleration voltage (0-1)","persistent-hint":""},null,8,["modelValue"])]),_:1}),h(m,{cols:"12",md:"4"},{default:E(()=>[h(i,{modelValue:k.kval_dec,"onUpdate:modelValue":t[6]||(t[6]=B=>k.kval_dec=B),modelModifiers:{number:!0},label:"KVAL Deceleration",type:"number",step:"0.01",min:"0",max:"1",hint:"Deceleration voltage (0-1)","persistent-hint":""},null,8,["modelValue"])]),_:1})]),_:1}),h(u,null,{default:E(()=>[h(m,{cols:"12",md:"6"},{default:E(()=>[h(i,{modelValue:k.stall_threshold,"onUpdate:modelValue":t[7]||(t[7]=B=>k.stall_threshold=B),modelModifiers:{number:!0},label:"Stall Threshold",type:"number",step:"0.1",min:"0.1",max:"5",hint:"Stall detection threshold","persistent-hint":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),h(z,null,{default:E(()=>[h(f,{color:"grey",onClick:C},{default:E(()=>t[11]||(t[11]=[R(" Reset to Defaults ")])),_:1}),h(_),h(f,{color:"grey",onClick:c},{default:E(()=>t[12]||(t[12]=[R(" Cancel ")])),_:1}),h(f,{color:"primary",onClick:P,loading:s.value},{default:E(()=>t[13]||(t[13]=[R(" Apply Settings ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}},Lt=Y(Rt,[["__scopeId","data-v-0483e935"]]);const Ut={key:0,class:"pump-controls"},Nt={key:1},Tt={class:"pump-input"},Bt={key:1},qt={__name:"PumpControl",setup(g){const n=le(),{pumps:e,valves:S,calibrationModeEnabled:b}=ne(n),s=F({}),D=fe({show:!1,pumpId:null,pumpName:""});se(()=>{var f;return(f=e.value)==null?void 0:f.states},f=>{},{immediate:!1});const k={1:"MAIN",2:"DRUG",3:"MISSING!!!",4:"WASTE"},A=fe({1:null,2:null,3:null,4:null}),P=fe({1:null,2:null,3:null,4:null});ie(()=>{e.value||n.fetchDeviceData()});async function C(f,x){if(x.ctrlKey&&x.shiftKey){D.pumpId=f,D.pumpName=k[f],D.show=!0;return}if(s.value[f]&&(clearInterval(s.value[f]),delete s.value[f]),e.value.states[f]==="running"){await n.setPartStateAction({devicePart:"pumps",partIndex:f,newState:"stopped"}),await n.fetchDeviceData();return}if(!Object.values(S.value.states).some(m=>m==="open")){alert("At least one valve must be open to start the pump");return}const i=parseFloat(P[f]);if(!i){alert("Please set the volume before starting the pump");return}try{s.value[f]=setInterval(async()=>{await n.fetchDeviceData(),e.value.states[f]!=="running"&&(clearInterval(s.value[f]),delete s.value[f])},500),await n.setPartStateAction({devicePart:"pumps",partIndex:f,newState:"running",input:{volume:i}}),setTimeout(()=>{s.value[f]&&(clearInterval(s.value[f]),delete s.value[f],n.fetchDeviceData())},3e4)}catch(m){console.error(`Error starting pump ${f}:`,m),e.value.states[f]="stopped",s.value[f]&&(clearInterval(s.value[f]),delete s.value[f])}}function c(f,x){P[x]=f;const d=parseFloat(P[x]);isNaN(d)?A[x]="":A[x]=t(d,x).toFixed(2)}function p(f,x){A[x]=f;const d=parseFloat(A[x]);isNaN(d)?P[x]="":P[x]=_(d,x)}function t(f,x){const d=e.value.calibration[x],i=Object.entries(d).map(([G,B])=>[parseInt(G),B]).sort((G,B)=>G[0]-B[0]);if(f>=i[i.length-1][0]*i[i.length-1][1])return f/i[i.length-1][1];let m=i[0],u=i[i.length-1];for(let G=0;G<i.length-1;G++)if(f>=i[G][0]*i[G][1]&&f<=i[G+1][0]*i[G+1][1]){m=i[G],u=i[G+1];break}const V=m[0]*m[1],K=u[0]*u[1],z=(f-V)/(K-V),oe=m[1]+(u[1]-m[1])*z;return f/oe}function _(f,x){const d=e.value.calibration[x],i=Object.entries(d).map(([z,oe])=>[parseInt(z),oe]).sort((z,oe)=>z[0]-oe[0]);if(f>=i[i.length-1][0])return(f*i[i.length-1][1]).toFixed(2);let m=i[0],u=i[i.length-1];for(let z=0;z<i.length-1;z++)if(f>=i[z][0]&&f<=i[z+1][0]){m=i[z],u=i[z+1];break}const V=(f-m[0])/(u[0]-m[0]),K=m[1]+(u[1]-m[1])*V;return(f*K).toFixed(2)}function y(f){console.log(`Pump ${f.pumpId} settings updated:`,f.params)}return(f,x)=>{const d=U("v-progress-circular"),i=U("v-btn"),m=U("v-text-field");return o(),v(q,null,[I(e)&&I(e).states?(o(),v("div",Ut,[(o(),v(q,null,Q([1,2,4],u=>r("div",{class:"pump",key:u},[h(i,{class:j(["pump-button",{"stop-button":I(e).states[u]==="running"}]),onClick:V=>C(u,V),title:`${k[u]} pump - Ctrl+Shift+Click for settings`},{default:E(()=>[I(e).states[u]==="running"?(o(),X(d,{key:0,indeterminate:"",color:"white",class:"spinner-custom",size:"64"})):(o(),v("span",Nt,[R(T(k[u]),1),x[1]||(x[1]=r("br",null,null,-1)),x[2]||(x[2]=R("pump"))]))]),_:2},1032,["class","onClick","title"]),r("div",Tt,[h(m,{label:"Volume (mL)",type:"number",dense:"",modelValue:P[u],"onUpdate:modelValue":[V=>P[u]=V,V=>c(V,u)]},null,8,["modelValue","onUpdate:modelValue"]),I(b)?(o(),X(m,{key:0,label:"Rotations",type:"number",dense:"",modelValue:A[u],"onUpdate:modelValue":[V=>A[u]=V,V=>p(V,u)]},null,8,["modelValue","onUpdate:modelValue"])):N("",!0),I(b)?(o(),X(At,{key:1,pumpId:u},null,8,["pumpId"])):N("",!0)])])),64))])):(o(),v("div",Bt," Loading pump data... ")),h(Lt,{modelValue:D.show,"onUpdate:modelValue":x[0]||(x[0]=u=>D.show=u),"pump-id":D.pumpId,"pump-name":D.pumpName,onSettingsUpdated:y},null,8,["modelValue","pump-id","pump-name"])],64)}}},jt=Y(qt,[["__scopeId","data-v-21f7fad7"]]);const Kt={class:"valve-calibration"},zt={class:"warning-header"},Gt={key:0,class:"loading-state"},Wt={key:1,class:"calibration-controls"},Ht={class:"slider-container"},Jt={class:"slider-label"},Qt={class:"value"},Zt={class:"slider-container"},Xt={class:"slider-label"},Yt={class:"value"},ea={class:"valve-controls"},ta={__name:"ValveCalibration",props:{valveId:{type:Number,required:!0}},setup(g){const n=g,e=le(),{valves:S}=ne(e),b=F(.03),s=F(.12),D=F(!1),k=F(!0);se(S,_=>{var y,f;_&&(b.value=((y=_.duty_cycle_open)==null?void 0:y[n.valveId])??.03,s.value=((f=_.duty_cycle_closed)==null?void 0:f[n.valveId])??.12),k.value=!1},{immediate:!0}),ie(async()=>{try{await e.fetchDeviceData()}catch(_){console.error("Error initializing valve calibration:",_),k.value=!1}});async function A(_){var y,f;D.value=!0;try{await e.setPartStateAction({devicePart:"valves",partIndex:n.valveId,newState:_?"open":"closed",input:{dutyCycle:_?b.value:s.value}}),W.success(`Valve ${n.valveId} ${_?"opened":"closed"} successfully`)}catch(x){if(console.error("Error operating valve:",x),!x.response)W.error("Server connection error. Please check if the backend server is running.");else{const d=((f=(y=x.response)==null?void 0:y.data)==null?void 0:f.message)||x.message||"Operation failed";W.error(`Failed to ${_?"open":"close"} valve ${n.valveId}: ${d}`)}}finally{D.value=!1}}async function P(){try{await ve.post("/set-valve-duty-cycle-open",{valve:n.valveId,duty_cycle:b.value}),W.success(`Valve ${n.valveId} open duty cycle set to ${b.value.toFixed(3)}`)}catch(_){console.error("Error updating open duty cycle:",_),W.error(`Failed to update valve ${n.valveId} open duty cycle`)}}async function C(){try{await ve.post("/set-valve-duty-cycle-closed",{valve:n.valveId,duty_cycle:s.value}),W.success(`Valve ${n.valveId} closed duty cycle set to ${s.value.toFixed(3)}`)}catch(_){console.error("Error updating closed duty cycle:",_),W.error(`Failed to update valve ${n.valveId} closed duty cycle`)}}async function c(){b.value=.03,s.value=.12;try{await Promise.all([P(),C()]),W.success(`Valve ${n.valveId} duty cycles reset to defaults`)}catch{W.error(`Failed to reset valve ${n.valveId} duty cycles`)}}function p(_){b.value=_}function t(_){s.value=_}return(_,y)=>{const f=U("v-icon"),x=U("v-progress-circular"),d=U("v-slider"),i=U("v-btn");return o(),v("div",Kt,[r("div",zt,[h(f,{color:"error",size:"large"},{default:E(()=>y[4]||(y[4]=[R("warning")])),_:1}),r("h2",null,"Warning! Valve "+T(g.valveId)+" Calibration Mode",1)]),k.value?(o(),v("div",Gt,[h(x,{indeterminate:"",color:"primary"}),y[5]||(y[5]=r("span",null,"Loading valve data...",-1))])):(o(),v("div",Wt,[r("div",Ht,[r("div",Jt,[y[6]||(y[6]=r("span",null,"Open Duty Cycle",-1)),r("span",Qt,T(b.value.toFixed(3)),1)]),h(d,{modelValue:b.value,"onUpdate:modelValue":[y[0]||(y[0]=m=>b.value=m),p],min:.02,max:.04,step:.001,color:"primary","track-color":"grey","thumb-label":"",onMouseup:P},null,8,["modelValue"])]),r("div",Zt,[r("div",Xt,[y[7]||(y[7]=r("span",null,"Closed Duty Cycle",-1)),r("span",Yt,T(s.value.toFixed(3)),1)]),h(d,{modelValue:s.value,"onUpdate:modelValue":[y[1]||(y[1]=m=>s.value=m),t],min:.11,max:.13,step:.001,color:"primary","track-color":"grey","thumb-label":"",onMouseup:C},null,8,["modelValue"])]),r("div",ea,[h(i,{color:"success",onClick:y[2]||(y[2]=m=>A(!0)),loading:D.value,disabled:D.value},{default:E(()=>y[8]||(y[8]=[R(" Open Valve ")])),_:1},8,["loading","disabled"]),h(i,{color:"error",onClick:y[3]||(y[3]=m=>A(!1)),loading:D.value,disabled:D.value},{default:E(()=>y[9]||(y[9]=[R(" Close Valve ")])),_:1},8,["loading","disabled"]),h(i,{color:"primary",onClick:c},{default:E(()=>y[10]||(y[10]=[R(" Reset Defaults ")])),_:1})])]))])}}},aa=Y(ta,[["__scopeId","data-v-2b40de6c"]]);const na={class:"valve-controls"},la=["onClick","disabled"],oa={key:0,class:"spinner-border spinner-custom",role:"status"},sa={key:1},ia={__name:"ValveControl",setup(g){const n=le(),{valves:e}=ne(n),S=F({}),b=new(window.AudioContext||window.webkitAudioContext),s=F(!1),D=F(null);function k(C){const c=C==="open"?500:300,p=C==="open"?300:500,t=b.createOscillator();t.type="sine";const _=b.createGain();return _.gain.setValueAtTime(.1,b.currentTime),t.connect(_),_.connect(b.destination),t.frequency.setValueAtTime(c,b.currentTime),t.frequency.linearRampToValueAtTime(p,b.currentTime+.3),t.start(),t.stop(b.currentTime+.3),t}async function A(C){const c=e.value.states[C];if(S.value[C])return;S.value={...S.value,[C]:!0};const p=k(c);try{await n.setPartStateAction({devicePart:"valves",partIndex:C,newState:c==="open"?"closed":"open"}),p.stop()}catch(t){console.error(t)}finally{S.value={...S.value,[C]:!1}}}function P(C,c){if(c.ctrlKey&&c.shiftKey){D.value=C,s.value=!0;return}A(C)}return(C,c)=>{const p=U("v-dialog");return o(),v(q,null,[r("div",na,[(o(),v(q,null,Q(7,t=>r("button",{class:j(["btn",{"btn-danger":I(e).states[t]==="closed"&&!S.value[t],"btn-success":I(e).states[t]==="open"&&!S.value[t],"btn-warning":S.value[t]}]),key:t,onClick:_=>P(t,_),disabled:S.value[t]},[S.value[t]?(o(),v("div",oa)):(o(),v("span",sa,"Valve "+T(t),1))],10,la)),64))]),h(p,{modelValue:s.value,"onUpdate:modelValue":c[1]||(c[1]=t=>s.value=t),"max-width":"600"},{default:E(()=>[s.value?(o(),X(aa,{key:0,valveId:D.value,onClose:c[0]||(c[0]=t=>s.value=!1)},null,8,["valveId"])):N("",!0)]),_:1},8,["modelValue"])],64)}}},ra=Y(ia,[["__scopeId","data-v-a341c808"]]);const ua={class:"elements-container"},ca={class:"stirrer-name"},da={key:0},va={style:{position:"relative",display:"inline-block"}},pa={style:{position:"relative",display:"inline-block"}},fa={class:"buttons-container"},Ie=0,Ve=1,ma={__name:"StirrerCalibration",props:{stirrerId:{type:Number,required:!0}},setup(g){const n=g,e=F(null),S=F(null),b=F(null),s=new(window.AudioContext||window.webkitAudioContext);let D=null,k=null,A=null;const P=le(),{calibrationModeEnabled:C,stirrers:c}=ne(P),p=H(()=>c.value&&c.value.states?c.value.states[n.stirrerId]:void 0);function t(m){P.setPartStateAction({devicePart:"stirrers",partIndex:n.stirrerId,newState:m})}function _(m){if(c.value&&c.value.states)for(let u=1;u<=7;u++)c.value.states[u]=m;P.setAllStirrersStateAction&&P.setAllStirrersStateAction(m)}function y(m,u){x(u.target.value)}function f(m,u){!c.value||!c.value.calibration||!c.value.calibration[n.stirrerId]||P.setPartCalibrationAction({devicePart:"stirrers",partIndex:n.stirrerId,newCalibration:{low:c.value.calibration[n.stirrerId].low,high:c.value.calibration[n.stirrerId].high}}).catch(V=>{console.error("Error updating stirrer calibration:",V)})}function x(m){D||(D=s.createOscillator(),k=s.createGain(),D.type="sine",k.gain.setValueAtTime(.1,s.currentTime),D.connect(k),k.connect(s.destination),D.start());const u=300+m*500;D.frequency.setValueAtTime(u,s.currentTime),A&&clearTimeout(A),A=setTimeout(d,200)}function d(){D&&(k.gain.exponentialRampToValueAtTime(.001,s.currentTime+.01),k.gain.setValueAtTime(.1,s.currentTime+.02),D.stop(s.currentTime+.02),D=null,k=null)}function i(m,u){(m==="high"&&p.value!=="high"||m==="low"&&p.value!=="low")&&(u.preventDefault(),W("Enable stirrer to adjust speed",{type:"info"}))}return ie(()=>{window.addEventListener("resize",()=>{})}),st(()=>{window.removeEventListener("resize",()=>{})}),(m,u)=>(o(),v("div",{class:"stirrer-calibrator",ref_key:"container",ref:e},[r("div",ua,[r("div",ca,[r("header",null,"Stirrer "+T(g.stirrerId),1)]),I(C)&&I(c)&&I(c).calibration&&I(c).calibration[g.stirrerId]?(o(),v("div",da,[r("div",va,[ce(r("input",{type:"range",class:j(["slider slider-high",[{active:p.value==="high"},{"slider-disabled":p.value!=="high"}]]),min:Ie,max:Ve,step:.01,"onUpdate:modelValue":u[0]||(u[0]=V=>I(c).calibration[g.stirrerId].high=V),onInput:u[1]||(u[1]=V=>y("high",V)),onChange:u[2]||(u[2]=V=>f())},null,34),[[de,I(c).calibration[g.stirrerId].high,void 0,{number:!0}]]),p.value!=="high"?(o(),v("div",{key:0,class:"slider-overlay",onClick:u[3]||(u[3]=V=>i("high",V))})):N("",!0)]),r("div",pa,[ce(r("input",{type:"range",class:j(["slider slider-low",[{active:p.value==="low"},{"slider-disabled":p.value!=="low"}]]),min:Ie,max:Ve,step:.01,"onUpdate:modelValue":u[4]||(u[4]=V=>I(c).calibration[g.stirrerId].low=V),onInput:u[5]||(u[5]=V=>y("low",V)),onChange:u[6]||(u[6]=V=>f())},null,34),[[de,I(c).calibration[g.stirrerId].low,void 0,{number:!0}]]),p.value!=="low"?(o(),v("div",{key:0,class:"slider-overlay",onClick:u[7]||(u[7]=V=>i("low",V))})):N("",!0)])])):N("",!0),r("div",fa,[r("button",{class:j(["button button-high",{active:p.value==="high"}]),ref_key:"buttonHigh",ref:S,onClick:u[8]||(u[8]=V=>t("high")),onDblclick:u[9]||(u[9]=V=>_("high"))},"High",34),r("button",{class:j(["button button-low",{active:p.value==="low"}]),ref_key:"buttonLow",ref:b,onClick:u[10]||(u[10]=V=>t("low")),onDblclick:u[11]||(u[11]=V=>_("low"))},"Low",34),r("button",{class:j(["button button-off",{active:p.value==="stopped"}]),ref:"buttonOff",onClick:u[12]||(u[12]=V=>t("stopped")),onDblclick:u[13]||(u[13]=V=>_("stopped"))},"OFF",34)])])],512))}},ga=Y(ma,[["__scopeId","data-v-d01f6391"]]);const ba={name:"StirrerControl",components:{StirrerCalibration:ga}},_a={class:"stirrer-controls"};function ya(g,n,e,S,b,s){const D=U("StirrerCalibration");return o(),v("div",_a,[(o(),v(q,null,Q(7,k=>h(D,{key:k,stirrerId:k},null,8,["stirrerId"])),64))])}const ha=Y(ba,[["render",ya],["__scopeId","data-v-6cada7fd"]]),Ca={className:"single-chart-container"},ka={__name:"ODChart",props:{partId:{type:Number,required:!0}},setup(g){me.register(Le,Ue,Ne,pt,Ae,Re,ft);const n=g,e=le(),{ods:S}=ne(e),b=H(()=>{var C,c;return(c=(C=S.value)==null?void 0:C.calibration)==null?void 0:c[n.partId]}),s=H(()=>{var C,c;return(c=(C=S.value)==null?void 0:C.calibration_coefs)==null?void 0:c[n.partId]}),D=H(()=>{var C,c,p,t;return{od:(c=(C=S.value)==null?void 0:C.states)==null?void 0:c[n.partId],signal:(t=(p=S.value)==null?void 0:p.odsignals)==null?void 0:t[n.partId]}});function k(C,c,p){return-Math.log10(C/c)*p}const A=H(()=>{if(b.value&&typeof b.value=="object"&&s.value){const C=Object.entries(b.value).filter(([_,y])=>y!==null).map(([_,y])=>({x:Number(y),y:Number(_)})).sort((_,y)=>_.x-y.x);let c=Math.min(...C.map(_=>_.x)),p=Math.max(...C.map(_=>_.x));const t=[];c===p&&(c=0,p=50);for(let _=c;_<=p;_+=.1){const y=k(_,...s.value);t.push({x:_,y})}return{datasets:[{label:`Vial ${n.partId} Calibration OD`,data:C,borderColor:"#607ecb",backgroundColor:"rgba(83,158,255,0.64)"},{label:`Vial ${n.partId} Current OD`,data:[{x:D.value.signal,y:D.value.od}],pointRadius:5,backgroundColor:"rgba(255,1,60,0.64)"},{label:`Vial ${n.partId} Fit`,data:t,pointRadius:0,borderColor:"rgba(0,70,220,0.38)",borderWidth:2,showLine:!0,fill:!1,borderDash:[2,2]}]}}return{}}),P=H(()=>{var C,c;return{devicePixelRatio:4,responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},title:{display:!0,text:`Vial ${n.partId}`+(s.value?`
blank: ${(C=s.value[0])==null?void 0:C.toFixed(2)}, scaling: ${(c=s.value[1])==null?void 0:c.toFixed(2)}`:"")}},scales:{x:{title:{display:!0,text:"Signal (mV)"},suggestedMin:0},y:{title:{display:!0,text:"OD"},suggestedMax:1.5,suggestedMin:0}}}});return(C,c)=>(o(),v("div",Ca,[h(I(Dt),{data:A.value,options:P.value},null,8,["data","options"])]))}};F({show:!1,title:"",content:"",resolve:null});const Da={class:"guide-popup"},wa={class:"guide-header"},Sa={__name:"ODGuide",setup(g){return(n,e)=>{const S=U("v-icon");return o(),v("div",{class:"guide-overlay",onClick:e[1]||(e[1]=rt(b=>n.$emit("close"),["self"]))},[r("div",Da,[r("div",wa,[e[3]||(e[3]=r("span",{class:"guide-title"},"OD Calibration Guide",-1)),r("button",{class:"guide-close",onClick:e[0]||(e[0]=b=>n.$emit("close"))},[h(S,null,{default:E(()=>e[2]||(e[2]=[R("mdi-close")])),_:1})])]),e[4]||(e[4]=it('<div class="guide-content" data-v-8d7af6ce><div class="guide-section" data-v-8d7af6ce><b class="section-title" data-v-8d7af6ce>What is Optical Density (OD)?</b><br data-v-8d7af6ce><span class="guide-text" data-v-8d7af6ce> Optical Density (OD) measures how much light is absorbed by a sample. The higher the OD, the more cells or particles are in the solution. </span></div><div class="guide-section" data-v-8d7af6ce><b class="section-title" data-v-8d7af6ce>Beer-Lambert Law and Scaling Factor</b><br data-v-8d7af6ce><span class="guide-text" data-v-8d7af6ce> The Beer-Lambert Law relates OD to the transmitted light signal: </span><br data-v-8d7af6ce><span class="formula" data-v-8d7af6ce> OD = -log₁₀(signal / blank_signal) </span><br data-v-8d7af6ce><span class="guide-text" data-v-8d7af6ce> In our devices, the light path is not a standard 1cm cuvette. The curved shape of the vial and the sensor design affect how light travels through the sample. This is corrected using a scaling factor: </span><br data-v-8d7af6ce><span class="formula" data-v-8d7af6ce> OD = -log₁₀(signal / blank_signal) * scaling </span><br data-v-8d7af6ce></div><div class="guide-section" data-v-8d7af6ce><b class="section-title" data-v-8d7af6ce>Calibration Process</b><div class="method-panel" data-v-8d7af6ce><div class="method-heading" data-v-8d7af6ce>Step 1: Measure OD₀ (Blank Signal)</div><div class="od-warning-box" data-v-8d7af6ce><b data-v-8d7af6ce>Important: OD₀ must be measured with a vial containing growth medium!</b><div class="od-warning-details" data-v-8d7af6ce> - Use the same growth medium that will be used in your experiment<br data-v-8d7af6ce> - The vial must be filled with liquid<br data-v-8d7af6ce> - A good blank signal should be above 20mV<br data-v-8d7af6ce> - If the signal is below 20mV, check for:<br data-v-8d7af6ce>   • Proper vial alignment<br data-v-8d7af6ce>   • Clean sensors and vials<br data-v-8d7af6ce>   • No obstructions in the light path </div></div></div><div class="method-panel" data-v-8d7af6ce><div class="method-heading" data-v-8d7af6ce>Step 2 (Optional): Measure additional OD values to calibrate the scaling factor</div><div class="option-container" data-v-8d7af6ce><div class="option-box" data-v-8d7af6ce><div class="method-subheading" data-v-8d7af6ce>Option A: Using Liquid Samples (Recommended)</div><ol class="guide-ol" data-v-8d7af6ce><li data-v-8d7af6ce>Prepare a vial with a known OD between 0.1 and 2.0: </li><li data-v-8d7af6ce>Insert this vial into each slot and measure its signal using the calibration table.</li><li data-v-8d7af6ce>The scaling factor will be automatically calculated from these measurements.</li><i data-v-8d7af6ce>Repeat with different OD values for increased accuracy.</i></ol></div><div class="option-box" data-v-8d7af6ce><div class="method-subheading" data-v-8d7af6ce>Option B: Using Semitransparent Sheets</div><ol class="guide-ol" data-v-8d7af6ce><li data-v-8d7af6ce>Determine the equivalent OD of one or more semitransparent sheets (using a solution which creates the same signal as the sheet inserted in the sensor)</li><li data-v-8d7af6ce>Place the sheet over all sensors at once</li><li data-v-8d7af6ce>Measure the signals and the scaling factor will be calculated automatically</li><i data-v-8d7af6ce>Note: This method is less accurate than using liquid samples</i></ol></div></div></div><div class="method-panel" data-v-8d7af6ce><div class="method-heading" data-v-8d7af6ce>Step 3: Final Check</div><div class="guide-text" data-v-8d7af6ce> Ideally, remeasure OD₀ just before starting the experiment. Small changes in the position of the vial and media composition can affect the signal. </div></div></div></div>',1))])])}}},$a=Y(Sa,[["__scopeId","data-v-8d7af6ce"]]);const xa={class:"od-control-container"},Oa=["onClick","disabled"],Ia={key:1},Va={key:0,class:"od-output-value error-message"},Ea={key:3,class:"signal-output-value error-message"},Pa={key:0,class:"calibration-section"},Ma={class:"probe-table-outer-container",style:{"margin-bottom":"18px"}},Fa={class:"table-controls"},Aa={class:"mode-controls"},Ra={class:"calibration-table-wrapper"},La={class:"calibration-table"},Ua={key:0,style:{width:"36px"}},Na={class:"od-value-container"},Ta=["onDblclick"],Ba=["value","onInput","onBlur","onKeyup"],qa=["title"],ja={key:1,class:"signal-value"},Ka={key:1,class:"signal-value"},za={key:1,class:"measure-cell-container"},Ga=["onDblclick"],Wa=["onDblclick"],Ha=["value","onInput","onBlur","onKeyup"],Ja=["onClick","disabled","title"],Qa={key:0,class:"measure-button-content"},Za={key:1,class:"measure-button-content"},Xa={key:0,style:{"text-align":"center",width:"36px",padding:"4px"}},Ya=["onClick","disabled"],en={key:1,style:{width:"36px"}},tn={key:0},an={class:"scaling-factor-container"},nn={class:"calibration-table"},ln={class:"scaling-factor-row"},on=["title"],sn=["onUpdate:modelValue"],rn=["onDblclick","title"],un=["onBlur","onKeyup"],cn={key:1},dn={key:0,style:{width:"40px"}},vn={key:0,class:"chart-container"},pn={__name:"ODControl",setup(g){const n=le(),{ods:e,calibrationModeEnabled:S}=ne(n),{openDialog:b}=we(),s=[1,2,3,4,5,6,7],D=F(!1),k=F(!0),A=F(!1),P=F(!1),C=F(null),c=F({}),p=F({}),t=F({}),_=H(()=>{let l=new Set;if(e.value.calibration)for(let M in e.value.calibration)for(let L in e.value.calibration[M])l.add(L);return Array.from(l).sort((M,L)=>parseFloat(M)-parseFloat(L))}),y=H(()=>{if(!e.value.calibration)return[];const l=new Set;for(const a in e.value.calibration)for(const M in e.value.calibration[a])l.add(parseFloat(M));return Array.from(l).sort((a,M)=>a-M)}),f=F(new Set),x=H(()=>{const l=e.value.calibration_coefs||{};return s.map(a=>{var M;return((M=l[a])==null?void 0:M[1])??"—"})}),d=F([]),i=F(null),m=F(null);se(x,l=>{d.value=[...l]},{immediate:!0}),ie(()=>{n.fetchDeviceData(),document.addEventListener("click",u)}),Me(()=>{document.removeEventListener("click",u)});function u(l){if(te.value&&!l.target.closest(".calibration-signal")&&be(te.value.vial,te.value.odValue),ae.value&&!l.target.closest(".od-value-input")){const a=y.value.indexOf(ae.value);a!==-1&&ge(ae.value,a),ae.value=null}i.value&&!l.target.closest(".scaling-factor-input")&&he(i.value)}async function V(l){var a,M;if(console.log("handleOdClick called with odIndex:",l,typeof l),C.value===null){C.value=l,delete c.value[l];try{console.log("Starting OD measurement for index:",l);const L=await ve.post("/measure-ods",{partIndex:l});if(console.log("Raw API response:",L),L.data.success)console.log("OD measurement successful for index:",l),await n.fetchDeviceData(),delete c.value[l];else throw console.log("API returned failure for index:",l),new Error(L.data.message||"Measurement failed")}catch(L){console.error("Error measuring OD:",L),console.log("Setting error for OD index:",l);const $=((M=(a=L.response)==null?void 0:a.data)==null?void 0:M.message)||L.message||"Measurement failed";c.value={...c.value,[l]:$},console.log("Error set for odIndex:",l,"error:",$),console.log("Full odErrors object:",c.value)}finally{C.value=null}}}function K(l,a,M){t.value[a]||(t.value[a]={}),t.value[a][M]=parseFloat(l.target.value)}function z(l,a){if(t.value[l]&&t.value[l][a]!==void 0){e.value.calibration[l]||(e.value.calibration[l]={});const M=t.value[l][a];isNaN(t.value[l][a])&&delete e.value.calibration[l][a],n.updateODCalibrationValueAction({od:a,vial:l,newValue:M}).catch(L=>{console.error(`Error updating calibration for vial ${l}:`,L)}),delete t.value[l][a]}}function oe(l,a){return t.value[l]&&t.value[l][a]!==void 0?t.value[l][a]:e.value.calibration&&e.value.calibration[l]&&e.value.calibration[l][a]!==void 0?e.value.calibration[l][a]:""}function G(l,a){if(!e.value.calibration||!e.value.calibration[l]||e.value.calibration[l][a]===void 0)return{background:""};const M=parseFloat(e.value.calibration[l][a]),L=5,$=40;let w;if(M<=0)w=L;else{const O=Math.log(10),Z=Math.log(1e3),lt=(Math.log(Math.max(10,Math.min(1e3,M)))-O)/(Z-O);w=L+lt*($-L)}return{background:`rgba(255, 100, 100, ${w/100})`}}function B(l){if(l==null)return"";const a=parseFloat(l);if(isNaN(a))return"";const M=.02,L=.25,$=Math.max(0,Math.min(4,a)),w=Math.log($+1)/Math.log(5),O=M+w*(L-M);return`background: linear-gradient(to right, rgba(255, 235, 156, ${O}), rgba(255, 235, 156, ${O*.6}))`}async function ge(l,a,M){if(p.value[a]!==void 0){const L=p.value[a];if(y.value.some((w,O)=>O!==a&&parseFloat(w)===parseFloat(L))&&!await b({title:"Duplicate OD Value",message:`An OD probe value of ${L} already exists. Are you sure you want to overwrite?`,showCancel:!0})){delete p.value[a];return}y.value[a]=L,delete p.value[a];try{for(let w in e.value.calibration){const O=e.value.calibration[w],Z=JSON.parse(JSON.stringify(O));O[l]!==void 0&&(delete Z[l],Z[L]=O[l],await n.setPartCalibrationAction({devicePart:"ods",partIndex:w,newCalibration:Z}))}await n.fetchDeviceData()}catch(w){console.error("Error updating calibration:",w),W.error("Failed to update calibration values")}}}function Ke(l,a){console.log("handleProbeValueInput",l.target.value),p.value[a]=parseFloat(l.target.value)}function ze(){A.value=!0}function Ge(){A.value=!1}function We(){if(!y.value.length)return .1;const l=Math.max(...y.value);return parseFloat((l+.1).toFixed(2))}async function He(){const l=We();for(const a of s)e.value.calibration[a]||(e.value.calibration[a]={}),e.value.calibration[a][l]=null,await n.setPartCalibrationAction({devicePart:"ods",partIndex:a,newCalibration:e.value.calibration[a]});await n.fetchDeviceData()}async function Je(l){const a=_.value[l];f.value.add(a);for(const M of s)e.value.calibration[M]&&(delete e.value.calibration[M][a],await n.setPartCalibrationAction({devicePart:"ods",partIndex:M,newCalibration:e.value.calibration[M]}));await n.fetchDeviceData(),f.value.delete(a)}const J={VIEW:"view",MEASURE:"measure"},ee=F(J.VIEW);H(()=>({"view-mode":ee.value===J.VIEW,"measure-mode":ee.value===J.MEASURE}));async function Qe(l,a){try{await n.measureDevicePart({devicePart:"ods",partIndex:l});const M=e.value.odsignals[l];await n.updateODCalibrationValueAction({od:a,vial:l,newValue:M}),await n.fetchDeviceData()}catch(M){console.error("Error measuring cell:",M)}}const te=F(null),Ze=F(null);function $e(l,a){te.value={vial:l,odValue:a},pe(()=>{const M=document.querySelector(".calibration-signal");M&&M.focus()})}function be(l,a){t.value[l]&&t.value[l][a]!==void 0&&z(l,a),te.value=null}function Xe(){if(te.value=null,te.value){const{vial:l,odValue:a}=te.value;t.value[l]&&delete t.value[l][a]}}const ae=F(null);function Ye(l,a){ae.value=l,pe(()=>{const M=document.querySelector(".od-value-input");M&&M.focus()})}function et(){if(ae.value=null,ae.value){const l=y.value.indexOf(ae.value);l!==-1&&p.value[l]&&delete p.value[l]}}const _e=(l,a)=>({icon:"",color:"#90caf9",tooltip:"Scaling factor"});function xe(l){return!e.value.calibration||!e.value.calibration[l]?0:Object.values(e.value.calibration[l]).filter(a=>a!=null).length}function ye(l){return xe(l)===1}function tt(l){const a=xe(l);return a>=2?"Scaling factor is automatically calculated from multiple calibration points. Cannot be edited.":a===1?"Double-click to edit scaling factor.":"No calibration points available for this vial."}function at(l){if(!ye(l))return;i.value=l;const a=d.value[l-1];m.value=typeof a=="number"?a:2,pe(()=>{const M=document.querySelector(".scaling-factor-input");M&&(M.focus(),M.select())})}async function he(l){if(i.value===l)try{m.value&&m.value>0&&await n.setODScalingFactorAction({vial:l,scalingFactor:m.value})}catch(a){console.error("Error setting scaling factor:",a)}finally{i.value=null,m.value=null}}function nt(){i.value=null,m.value=null}const Ce=l=>typeof l!="number"?{icon:"mdi-help-circle-outline",color:"grey",tooltip:"No signal value available"}:l>=20?{icon:"mdi-check-circle",color:"#4caf50",tooltip:"Signal value within expected range"}:l>=12?{icon:"mdi-alert-circle",color:"#ffc107",tooltip:"Signal value slightly low. Consider recalibrating"}:{icon:"mdi-close-circle",color:"#f44336",tooltip:"Signal value too low. Check OD sensor"};return(l,a)=>{const M=U("v-progress-circular"),L=U("v-icon");return o(),v(q,null,[r("div",xa,[(o(!0),v(q,null,Q(I(e).states,($,w)=>(o(),v("div",{class:"elements-container",key:w},[r("button",{class:"od-button",onClick:O=>V(w),disabled:C.value===w},[C.value===w?(o(),X(M,{key:0,indeterminate:"",color:"white",size:"24"})):(o(),v("span",Ia,"OD "+T(w),1))],8,Oa),c.value[w]?(o(),v("span",Va,T(c.value[w]),1)):I(e).states&&I(e).states[w]!==void 0&&I(e).states[w]!==0?(o(),v("span",{key:1,class:j(["od-output-value",{"value-being-replaced":C.value===w}])},T(parseFloat(I(e).states[w].toFixed(2))),3)):(o(),v("span",{key:2,class:j(["od-output-value",{"value-being-replaced":C.value===w}])},"---",2)),a[2]||(a[2]=r("div",{style:{height:"0.5px"}},null,-1)),c.value[w]?(o(),v("span",Ea)):I(e).odsignals&&I(e).odsignals[w]!==void 0&&I(e).odsignals[w]!==0?(o(),v("span",{key:4,class:j(["signal-output-value",{"value-being-replaced":C.value===w}])},"("+T(parseFloat(I(e).odsignals[w].toFixed(2)))+"mV)",3)):(o(),v("span",{key:5,class:j(["signal-output-value",{"value-being-replaced":C.value===w}])},"(---)",2))]))),128))]),I(S)?(o(),v("div",Pa,[r("div",Ma,[a[7]||(a[7]=r("div",{style:{display:"flex","align-items":"center","margin-bottom":"8px"}},null,-1)),r("div",Fa,[a[6]||(a[6]=r("div",{style:{flex:"1"}},null,-1)),r("div",Aa,[r("button",{class:j(["control-button mode-toggle",{active:ee.value===J.MEASURE}]),onClick:a[0]||(a[0]=$=>ee.value=ee.value===J.MEASURE?J.VIEW:J.MEASURE)},[h(L,null,{default:E(()=>a[3]||(a[3]=[R("mdi-pencil")])),_:1}),a[4]||(a[4]=R(" Edit "))],2)]),r("button",{class:"control-button help-button",onClick:ze},[h(L,null,{default:E(()=>a[5]||(a[5]=[R("mdi-help-circle-outline")])),_:1})])])]),a[16]||(a[16]=r("div",{class:"calibration-controls"},null,-1)),r("div",Ra,[r("table",La,[r("thead",null,[r("tr",null,[a[8]||(a[8]=r("th",{style:{width:"110px"}},"OD Value",-1)),(o(),v(q,null,Q(s,$=>r("th",{key:$,style:{width:"90px"}},"Vial "+T($),1)),64)),D.value?(o(),v("th",Ua)):N("",!0)])]),r("tbody",null,[(o(!0),v(q,null,Q(_.value,($,w)=>(o(),v("tr",{key:$,class:j({"od-zero-row":parseFloat($)===0})},[r("td",{style:Oe([{width:"110px"},B($)])},[r("div",Na,[!ae.value||ae.value!==$?(o(),v("span",{key:0,class:"od-value-display",onDblclick:O=>Ye($),title:"Double click to edit"},T(w<y.value.length?p.value[w]!==void 0?p.value[w]:y.value[w]:$),41,Ta)):(o(),v("input",{key:1,value:p.value[w]!==void 0?p.value[w]:y.value[w],onInput:O=>Ke(O,w),onBlur:O=>ge($,w),onKeyup:[re(O=>ge($,w),["enter"]),re(et,["esc"])],type:"number",step:"0.1",class:"od-value-input",ref_for:!0,ref:"odValueInput"},null,40,Ba))])],4),(o(),v(q,null,Q(s,O=>r("td",{key:O,class:j({"has-data":I(e).calibration&&I(e).calibration[O]&&I(e).calibration[O][$]!==void 0}),style:Oe({background:G(O,$).background})},[ee.value===J.VIEW?(o(),v(q,{key:0},[I(e).calibration&&I(e).calibration[O]&&I(e).calibration[O][$]!==void 0&&I(e).calibration[O][$]!==null?(o(),v(q,{key:0},[parseFloat($)===0?(o(),v("div",{key:0,class:"signal-value-with-status",title:Ce(I(e).calibration[O][$]).tooltip},[R(T(I(e).calibration[O][$].toFixed(2))+" ",1),h(L,{color:Ce(I(e).calibration[O][$]).color,size:"small",style:{"margin-left":"4px"}},{default:E(()=>[R(T(Ce(I(e).calibration[O][$]).icon),1)]),_:2},1032,["color"])],8,qa)):(o(),v("div",ja,T(I(e).calibration[O][$].toFixed(2)),1))],64)):(o(),v("div",Ka,"---"))],64)):ee.value===J.MEASURE?(o(),v("div",za,[I(e).calibration&&I(e).calibration[O]&&I(e).calibration[O][$]!==void 0&&I(e).calibration[O][$]!==null?(o(),v("span",{key:0,class:"signal-value measure-background-value",onDblclick:Z=>$e(O,$),title:"Double click to edit"},T(parseFloat(I(e).calibration[O][$]).toFixed(2))+"mV ",41,Ga)):(o(),v("span",{key:1,class:"signal-value measure-background-value empty-value",onDblclick:Z=>$e(O,$),title:"Double click to edit"}," ——— ",40,Wa)),te.value&&te.value.vial===O&&te.value.odValue===$?(o(),v("input",{key:2,value:oe(O,$),onInput:Z=>K(Z,O,$),onBlur:Z=>be(O,$),onKeyup:[re(Z=>be(O,$),["enter"]),re(Xe,["esc"])],type:"number",class:"calibration-signal",ref_for:!0,ref_key:"editingInput",ref:Ze},null,40,Ha)):N("",!0),r("button",{class:"measure-cell-button",onClick:Z=>Qe(O,$),disabled:P.value,title:`Calibrate OD ${parseFloat($).toFixed(2)} signal in vial ${O} (measure now)`},[P.value?(o(),v("span",Qa,a[9]||(a[9]=[r("span",{class:"loading-spinner"},null,-1)]))):(o(),v("span",Za,[h(L,null,{default:E(()=>a[10]||(a[10]=[R("mdi-camera-metering-center")])),_:1})]))],8,Ja)])):N("",!0)],6)),64)),ee.value===J.MEASURE&&parseFloat(_.value[w])!==0?(o(),v("td",Xa,[r("button",{class:"delete-od-row",onClick:O=>Je(w),disabled:f.value.has(_.value[w]),title:"Delete row"},[h(L,null,{default:E(()=>a[11]||(a[11]=[R("mdi-delete")])),_:1})],8,Ya)])):ee.value===J.MEASURE?(o(),v("td",en)):N("",!0)],2))),128)),ee.value===J.MEASURE?(o(),v("tr",tn,[r("td",null,[r("button",{class:"add-od-probe-table",onClick:He},[h(L,null,{default:E(()=>a[12]||(a[12]=[R("mdi-plus")])),_:1}),a[13]||(a[13]=R(" Add "))])]),(o(),v(q,null,Q(s,$=>r("td",{key:"add-row-"+$})),64)),a[14]||(a[14]=r("td",null,null,-1))])):N("",!0)])])]),r("div",an,[r("table",nn,[r("tbody",null,[r("tr",ln,[a[15]||(a[15]=r("th",{class:"scaling-factor-label"},"Scaling Factor",-1)),(o(!0),v(q,null,Q(d.value,($,w)=>(o(),v("th",{key:"sf-head-"+w,class:"scaling-factor-cell",title:_e().tooltip},[D.value?ce((o(),v("input",{key:0,type:"number",step:"0.01",min:"0.1","onUpdate:modelValue":O=>d.value[w]=O,style:{width:"60px","text-align":"center",background:"#23272e",color:"#90caf9",border:"1px solid #444","border-radius":"4px"}},null,8,sn)),[[de,d.value[w],void 0,{number:!0}]]):(o(),v("div",{key:1,class:j(["scaling-factor-value",{editable:ye(w+1),"non-editable":!ye(w+1)}]),onDblclick:O=>at(w+1),title:tt(w+1)},[i.value===w+1?ce((o(),v("input",{key:0,"onUpdate:modelValue":a[1]||(a[1]=O=>m.value=O),onBlur:O=>he(w+1),onKeyup:[re(O=>he(w+1),["enter"]),re(nt,["esc"])],type:"number",step:"0.01",min:"0.1",class:"scaling-factor-input",ref_for:!0,ref:"scalingFactorInput"},null,40,un)),[[de,m.value,void 0,{number:!0}]]):(o(),v("span",cn,[R(T(typeof $=="number"?$.toFixed(2):$)+" ",1),h(L,{color:_e().color,size:"small",style:{"margin-left":"4px"}},{default:E(()=>[R(T(_e($,w+1).icon),1)]),_:2},1032,["color"])]))],42,rn))],8,on))),128)),ee.value===J.MEASURE?(o(),v("th",dn)):N("",!0)])])])]),k.value?(o(),v("div",vn,[(o(),v(q,null,Q(s,$=>h(ka,{partId:$,key:$},null,8,["partId"])),64))])):N("",!0)])):N("",!0),A.value?(o(),X($a,{key:1,onClose:Ge})):N("",!0)],64)}}},fn=Y(pn,[["__scopeId","data-v-6b75e0ac"]]);const Se=le(),{leds:mn}=ne(Se);ie(()=>{mn.value||Se.fetchDeviceData()});const gn={name:"SetLEDColor",data(){return{vials:[1,2,3,4,5,6,7],ledColors:{1:{red:0,green:0,blue:0,color:"#000000"},2:{red:0,green:0,blue:0,color:"#000000"},3:{red:0,green:0,blue:0,color:"#000000"},4:{red:0,green:0,blue:0,color:"#000000"},5:{red:0,green:0,blue:0,color:"#000000"},6:{red:0,green:0,blue:0,color:"#000000"},7:{red:0,green:0,blue:0,color:"#000000"}}}},methods:{async setLEDColor(g,n){if(n.shiftKey){const{red:e,green:S,blue:b}=this.ledColors[g];for(const s of this.vials)this.ledColors[s].red=e,this.ledColors[s].green=S,this.ledColors[s].blue=b,this.ledColors[s].color=this.ledColors[g].color,await this.setIndividualLEDColor(s)}else await this.setIndividualLEDColor(g)},async setIndividualLEDColor(g){const{red:n,green:e,blue:S}=this.ledColors[g];try{console.log("Setting color for vial",g,"to",n,e,S),await Se.setLedColor(g,n,e,S)}catch(b){console.error(`Failed to set color for vial ${g}:`,b),alert(`Error setting color for vial ${g}`)}},updateColor(g){const n=this.ledColors[g].color,{r:e,g:S,b}=this.hexToRgb(n);this.ledColors[g].red=e/255,this.ledColors[g].green=S/255,this.ledColors[g].blue=b/255},hexToRgb(g){const n=parseInt(g.slice(1),16);return{r:n>>16&255,g:n>>8&255,b:n&255}}}},bn={class:"rgb-control-container"},_n={class:"color-selector"},yn=["onUpdate:modelValue","onInput"],hn=["onClick"];function Cn(g,n,e,S,b,s){return o(),v("div",bn,[(o(!0),v(q,null,Q(b.vials,D=>(o(),v("div",{class:"vial-container",key:D},[r("div",_n,[r("label",null,T("Vial "+D),1),ce(r("input",{type:"color","onUpdate:modelValue":k=>b.ledColors[D].color=k,onInput:k=>s.updateColor(D)},null,40,yn),[[de,b.ledColors[D].color]])]),r("button",{class:"set-color-button",onClick:k=>s.setLEDColor(D,k)},"Set",8,hn)]))),128))])}const kn=Y(gn,[["render",Cn],["__scopeId","data-v-0f12a494"]]);const Dn={class:"device-configs"},wn={class:"config-actions"},Sn={key:0,class:"error-message"},$n={key:1,class:"config-list mt-4"},xn={key:0},On={key:1,class:"text-muted"},In={__name:"DeviceConfigs",setup(g){const n=le(),{openDialog:e}=we(),S=F([]),b=F(""),s=F(!1),D=F(null),k=F(null);async function A(){b.value="",s.value=!0;try{const p=await n.listDeviceConfigs();S.value=(p||[]).sort((t,_)=>_.localeCompare(t))}catch{b.value="Failed to list device configs."}finally{s.value=!1}}async function P(p){b.value="",D.value=p;try{await n.loadDeviceConfig(p)}catch{b.value="Failed to load device config."}finally{D.value=null}}const C=async()=>{b.value="";try{await n.saveCalibrationToBackend(),W.success("Calibration checkpoint saved!")}catch{b.value="Failed to save device configs."}};function c(p){k.value=p,e({title:"Load checkpoint?",message:"Replace default config with checkpoint?"}).then(async t=>{t&&(await P(k.value),k.value=null)})}return(p,t)=>{const _=U("v-icon"),y=U("v-btn"),f=U("v-list-item"),x=U("v-list");return o(),v("div",Dn,[r("div",wn,[h(y,{color:"success",onClick:C},{default:E(()=>[h(_,{left:""},{default:E(()=>t[0]||(t[0]=[R("mdi-content-save")])),_:1}),t[1]||(t[1]=R(" Save Calibration "))]),_:1}),h(y,{color:"primary",onClick:A,loading:s.value,class:"mr-2"},{default:E(()=>[h(_,{left:""},{default:E(()=>t[2]||(t[2]=[R("mdi-folder-open")])),_:1}),t[3]||(t[3]=R(" Load Calibration Checkpoints "))]),_:1},8,["loading"])]),b.value?(o(),v("div",Sn,T(b.value),1)):N("",!0),S.value.length>0||s.value?(o(),v("div",$n,[t[6]||(t[6]=r("h3",{class:"text-h6 mb-2"},"Available Device Calibration Checkpoints",-1)),S.value.length>0?(o(),v("div",xn,[h(x,null,{default:E(()=>[(o(!0),v(q,null,Q(S.value,d=>(o(),X(f,{key:d,onClick:i=>c(d),class:j({"config-item":!0,loading:D.value===d})},{default:E(()=>[h(_,{left:""},{default:E(()=>t[4]||(t[4]=[R("mdi-file-document")])),_:1}),R(" "+T(d)+" ",1),D.value===d?(o(),X(_,{key:0,right:""},{default:E(()=>t[5]||(t[5]=[R("mdi-loading")])),_:1})):N("",!0)]),_:2},1032,["onClick","class"]))),128))]),_:1})])):s.value?N("",!0):(o(),v("div",On,' Click "Refresh Configs" to load. '))])):N("",!0)])}}},Vn=Y(In,[["__scopeId","data-v-ecd4ed1d"]]);const En={key:0,class:"experiment-running-overlay"},Pn={key:1,class:"experiment-running-overlay"},Mn={class:"overlay-content"},Fn={class:"warning-message"},An={class:"calibration-switch-row"},Rn={key:3},Ln={__name:"DeviceControl",setup(g){const n=le(),e=ut(),{deviceConnected:S,deviceControlEnabled:b,calibrationModeEnabled:s,stirrers:D,pumps:k,valves:A,ods:P}=ne(n),{currentExperiment:C}=ne(e),c=F(!1),p=H(()=>b.value),t=H({get:()=>s.value,set:d=>n.setCalibrationModeEnabled(d)}),_=H(()=>{var d;return((d=C.value)==null?void 0:d.status)==="running"}),{openDialog:y}=we();function f(){c.value=!0,W.warning("Device control bypass enabled. Use caution during running experiment.",{autoClose:5e3})}async function x(){console.log("onReconnectClick"),await y({title:"Reconnect Device?",message:"Are you sure you want to reconnect the device?"})?(W.success("Reconnecting device..."),n.connectDevice()):W.error("Reconnect cancelled")}return ie(()=>{n.fetchDeviceData(),e.fetchCurrentExperiment()}),(d,i)=>{const m=U("v-icon"),u=U("v-btn"),V=U("v-switch");return o(),v("div",{class:j(["DeviceControl",{"device-disconnected":I(S)===!1,"experiment-running-bg":_.value}])},[I(b)===!1?(o(),v("div",En)):N("",!0),_.value&&!c.value?(o(),v("div",Pn,[r("div",Mn,[r("div",Fn,[h(m,{color:"white",size:"48"},{default:E(()=>i[1]||(i[1]=[R("mdi-flask")])),_:1}),i[2]||(i[2]=r("h2",null,"Experiment Running",-1)),i[3]||(i[3]=r("p",null,"Device controls are locked during experiment",-1))]),h(u,{class:"bypass-button",color:"error",size:"large",onClick:f},{default:E(()=>[h(m,{left:""},{default:E(()=>i[4]||(i[4]=[R("mdi-close")])),_:1}),i[5]||(i[5]=R(" Bypass "))]),_:1})])])):N("",!0),r("div",An,[I(s)?(o(),X(u,{key:0,class:"reconnect-btn",onClick:x},{default:E(()=>i[6]||(i[6]=[R("Reconnect Device")])),_:1})):N("",!0),h(V,{modelValue:t.value,"onUpdate:modelValue":i[0]||(i[0]=K=>t.value=K),label:"Calibration Mode"},null,8,["modelValue"])]),I(b)||p.value||c.value?(o(),v(q,{key:2},[h(jt),h(ra),h(ha),h(fn),h(kn),I(s)?(o(),X(Vn,{key:0})):N("",!0)],64)):(o(),v("p",Rn,"Device Control Disabled"))],2)}}},jn=Y(Ln,[["__scopeId","data-v-f514329e"]]);export{jn as default};
